# 現在のテーブル設計

## 概要

勤怠管理アプリケーションの現在のテーブル設計とリレーションをまとめたドキュメントです。  
**更新日**: 2025 年 11 月 27 日（roles テーブル追加後）

---

## テーブル一覧

本アプリケーションでは、以下の **6 つのテーブル**を使用しています：

1. `users` - ユーザー情報
2. `roles` - ロール情報（2025 年 11 月 27 日追加）
3. `attendances` - 勤怠情報
4. `break_times` - 休憩情報
5. `stamp_correction_requests` - 修正申請情報
6. `break_corrections` - 休憩修正情報

---

## 1. users テーブル

### テーブル構造

| カラム名            | 型           | 制約             | 説明                         |
| ------------------- | ------------ | ---------------- | ---------------------------- |
| `id`                | unsigned int | PRIMARY KEY      | ユーザー ID                  |
| `name`              | varchar(255) | NOT NULL         | ユーザー名                   |
| `email`             | varchar(255) | NOT NULL, UNIQUE | メールアドレス               |
| `email_verified_at` | timestamp    | NULL 許可        | メール認証日時（未使用）     |
| `password`          | varchar(255) | NOT NULL         | パスワード（ハッシュ化）     |
| `role_id`           | unsigned int | NOT NULL, FK     | ロール ID（roles.id を参照） |
| `remember_token`    | varchar(100) | NULL 許可        | ログイン保持トークン         |
| `created_at`        | timestamp    | NULL 許可        | 作成日時                     |
| `updated_at`        | timestamp    | NULL 許可        | 更新日時                     |

### 外部キー制約

-   `role_id` → `roles.id` (ON DELETE RESTRICT)

### インデックス

-   `email` に UNIQUE インデックス

### マイグレーションファイル

-   `2014_10_12_000000_create_users_table.php` - テーブル作成
-   `2025_11_27_200001_change_users_table_role_to_role_id.php` - role → role_id への変更

### 備考

-   **変更履歴**: 2025 年 11 月 27 日に`role`カラム（integer 型）から`role_id`カラム（外部キー）に変更
-   既存データは自動的に移行される（role=0 → role_id=1, role=1 → role_id=2）

---

## 2. roles テーブル

### テーブル構造

| カラム名     | 型           | 制約             | 説明                        |
| ------------ | ------------ | ---------------- | --------------------------- |
| `id`         | unsigned int | PRIMARY KEY      | ロール ID                   |
| `name`       | varchar(255) | NOT NULL, UNIQUE | ロール名（'user', 'admin'） |
| `label`      | varchar(255) | NOT NULL         | ロール表示名                |
| `created_at` | timestamp    | NULL 許可        | 作成日時                    |
| `updated_at` | timestamp    | NULL 許可        | 更新日時                    |

### インデックス

-   `name` に UNIQUE インデックス

### 初期データ

マイグレーション実行時に自動的に以下のデータが投入されます：

| id  | name  | label        |
| --- | ----- | ------------ |
| 1   | user  | 一般ユーザー |
| 2   | admin | 管理者       |

### マイグレーションファイル

-   `2025_11_27_200000_create_roles_table.php` - テーブル作成（初期データ投入含む）

### 備考

-   **追加日**: 2025 年 11 月 27 日
-   ロール管理をテーブル化することで、将来的な拡張性を確保

---

## 3. attendances テーブル

### テーブル構造

| カラム名         | 型           | 制約         | 説明                           |
| ---------------- | ------------ | ------------ | ------------------------------ |
| `id`             | unsigned int | PRIMARY KEY  | 勤怠 ID                        |
| `user_id`        | unsigned int | NOT NULL, FK | ユーザー ID（users.id を参照） |
| `date`           | date         | NOT NULL     | 勤怠日（Y-m-d 形式）           |
| `clock_in_time`  | datetime     | NULL 許可    | 出勤日時                       |
| `clock_out_time` | datetime     | NULL 許可    | 退勤日時                       |
| `status`         | unsigned int | NOT NULL     | 勤怠ステータス（0-3）          |
| `note`           | varchar(500) | NULL 許可    | 備考                           |
| `created_at`     | timestamp    | NULL 許可    | 作成日時                       |
| `updated_at`     | timestamp    | NULL 許可    | 更新日時                       |

### 外部キー制約

-   `user_id` → `users.id` (ON DELETE CASCADE)

### インデックス

-   `user_id` と `date` の組み合わせで UNIQUE 制約（1 日 1 レコード）

### ステータス値

| 値  | 定数名          | ラベル | 説明                               |
| --- | --------------- | ------ | ---------------------------------- |
| 0   | STATUS_OFF_DUTY | 勤務外 | まだ出勤していない状態             |
| 1   | STATUS_WORKING  | 出勤中 | 出勤中、休憩中でも退勤済みでもない |
| 2   | STATUS_BREAK    | 休憩中 | 休憩ボタンを押した状態             |
| 3   | STATUS_FINISHED | 退勤済 | 退勤ボタンを押した後の状態         |

### マイグレーションファイル

-   `2025_11_12_181409_create_attendances_table.php`

### 備考

-   `date`カラムと`clock_in_time`/`clock_out_time`カラムを分けることで、日付跨ぎ勤怠に対応
-   `user_id`と`date`の組み合わせでユニーク制約（1 日 1 レコード）

---

## 4. break_times テーブル

### テーブル構造

| カラム名           | 型           | 制約         | 説明                             |
| ------------------ | ------------ | ------------ | -------------------------------- |
| `id`               | unsigned int | PRIMARY KEY  | 休憩 ID                          |
| `attendance_id`    | unsigned int | NOT NULL, FK | 勤怠 ID（attendances.id を参照） |
| `break_start_time` | datetime     | NULL 許可    | 休憩開始日時                     |
| `break_end_time`   | datetime     | NULL 許可    | 休憩終了日時                     |
| `created_at`       | timestamp    | NULL 許可    | 作成日時                         |
| `updated_at`       | timestamp    | NULL 許可    | 更新日時                         |

### 外部キー制約

-   `attendance_id` → `attendances.id` (ON DELETE CASCADE)

### マイグレーションファイル

-   `2025_11_12_181415_create_break_times_table.php`

### 備考

-   1 つの勤怠レコードに対して複数の休憩レコードが存在可能（1 日に複数回休憩可能）
-   `break_start_time`と`break_end_time`の両方が存在する場合のみ有効な休憩として扱う

---

## 5. stamp_correction_requests テーブル

### テーブル構造

| カラム名                   | 型           | 制約         | 説明                             |
| -------------------------- | ------------ | ------------ | -------------------------------- |
| `id`                       | unsigned int | PRIMARY KEY  | 修正申請 ID                      |
| `attendance_id`            | unsigned int | NOT NULL, FK | 勤怠 ID（attendances.id を参照） |
| `requested_clock_in_time`  | datetime     | NULL 許可    | 申請された出勤日時               |
| `requested_clock_out_time` | datetime     | NULL 許可    | 申請された退勤日時               |
| `requested_note`           | varchar(500) | NOT NULL     | 申請された備考                   |
| `status`                   | unsigned int | NOT NULL     | 申請ステータス（0-2）            |
| `approved_at`              | timestamp    | NULL 許可    | 承認日時                         |
| `created_at`               | timestamp    | NULL 許可    | 作成日時                         |
| `updated_at`               | timestamp    | NULL 許可    | 更新日時                         |

### 外部キー制約

-   `attendance_id` → `attendances.id` (ON DELETE CASCADE)

### ステータス値

| 値  | 定数名          | ラベル   | 説明                                   |
| --- | --------------- | -------- | -------------------------------------- |
| 0   | STATUS_PENDING  | 承認待ち | 申請を提出したが、まだ承認されていない |
| 1   | STATUS_APPROVED | 承認済み | 管理者が承認した状態                   |


### マイグレーションファイル

-   `2025_11_12_181421_create_stamp_correction_requests_table.php`

### 備考

-   1 つの勤怠レコードに対して複数の修正申請レコードが存在可能
-   承認待ちの申請がある場合、画面表示では申請された値が優先される

---

## 6. break_corrections テーブル

### テーブル構造

| カラム名                      | 型           | 制約         | 説明                                               |
| ----------------------------- | ------------ | ------------ | -------------------------------------------------- |
| `id`                          | unsigned int | PRIMARY KEY  | 休憩修正 ID                                        |
| `stamp_correction_request_id` | unsigned int | NOT NULL, FK | 修正申請 ID（stamp_correction_requests.id を参照） |
| `requested_break_start_time`  | datetime     | NULL 許可    | 申請された休憩開始日時                             |
| `requested_break_end_time`    | datetime     | NULL 許可    | 申請された休憩終了日時                             |
| `created_at`                  | timestamp    | NULL 許可    | 作成日時                                           |
| `updated_at`                  | timestamp    | NULL 許可    | 更新日時                                           |

### 外部キー制約

-   `stamp_correction_request_id` → `stamp_correction_requests.id` (ON DELETE CASCADE)

### マイグレーションファイル

-   `2025_11_12_181426_create_break_corrections_table.php`

### 備考

-   1 つの修正申請に対して複数の休憩修正レコードが存在可能
-   修正申請承認時に、このテーブルのデータが`break_times`テーブルに反映される

---

## リレーション一覧

### User モデル

**リレーション**:

-   `belongsTo` → `Role`（1 ユーザー：1 ロール）
    -   `$user->role` でアクセス
-   `hasMany` → `Attendance`（1 ユーザー：複数勤怠）
    -   `$user->attendances` でアクセス
-   `hasManyThrough` → `StampCorrectionRequest`（申請者として）
    -   `$user->stampCorrectionRequests` でアクセス
    -   `attendances`テーブル経由で取得

**実装**:

```php
// User.php
public function role() {
    return $this->belongsTo(Role::class);
}

public function attendances() {
    return $this->hasMany(Attendance::class);
}

public function stampCorrectionRequests() {
    return $this->hasManyThrough(
        StampCorrectionRequest::class,
        Attendance::class,
        'user_id',      // attendancesテーブルの外部キー
        'attendance_id', // stamp_correction_requestsテーブルの外部キー
        'id',           // usersテーブルのローカルキー
        'id'            // attendancesテーブルのローカルキー
    );
}
```

**ヘルパーメソッド**:

```php
public function isAdmin(): bool {
    // リレーションがロードされていない場合は自動的にロード
    if (!$this->relationLoaded('role')) {
        $this->load('role');
    }
    return $this->role && $this->role->isAdmin();
}

public function isUser(): bool {
    // リレーションがロードされていない場合は自動的にロード
    if (!$this->relationLoaded('role')) {
        $this->load('role');
    }
    return $this->role && $this->role->isUser();
}
```

---

### Role モデル

**リレーション**:

-   `hasMany` → `User`（1 ロール：複数ユーザー）
    -   `$role->users` でアクセス（実装されていない場合あり）

**実装**:

```php
// Role.php
// リレーションは必要に応じて実装可能
public function users() {
    return $this->hasMany(User::class);
}
```

**ヘルパーメソッド**:

```php
public function isAdmin(): bool {
    return $this->name === self::NAME_ADMIN;
}

public function isUser(): bool {
    return $this->name === self::NAME_USER;
}
```

**定数**:

```php
public const NAME_USER = 'user';
public const NAME_ADMIN = 'admin';
```

---

### Attendance モデル

**リレーション**:

-   `belongsTo` → `User`（1 勤怠：1 ユーザー）
    -   `$attendance->user` でアクセス
-   `hasMany` → `BreakTime`（1 勤怠：複数休憩）
    -   `$attendance->breaks` でアクセス
-   `hasMany` → `StampCorrectionRequest`（1 勤怠：複数修正申請）
    -   `$attendance->stampCorrectionRequests` でアクセス

**実装**:

```php
// Attendance.php
public function user() {
    return $this->belongsTo(User::class);
}

public function breaks() {
    return $this->hasMany(BreakTime::class);
}

public function stampCorrectionRequests() {
    return $this->hasMany(StampCorrectionRequest::class);
}
```

---

### BreakTime モデル

**リレーション**:

-   `belongsTo` → `Attendance`（1 休憩：1 勤怠）
    -   `$breakTime->attendance` でアクセス

**実装**:

```php
// BreakTime.php
public function attendance() {
    return $this->belongsTo(Attendance::class);
}
```

---

### StampCorrectionRequest モデル

**リレーション**:

-   `belongsTo` → `Attendance`（1 修正申請：1 勤怠）
    -   `$request->attendance` でアクセス
-   `hasMany` → `BreakCorrection`（1 修正申請：複数休憩修正）
    -   `$request->breakCorrections` でアクセス

**実装**:

```php
// StampCorrectionRequest.php
public function attendance() {
    return $this->belongsTo(Attendance::class);
}

public function breakCorrections() {
    return $this->hasMany(BreakCorrection::class);
}
```

---

### BreakCorrection モデル

**リレーション**:

-   `belongsTo` → `StampCorrectionRequest`（1 休憩修正：1 修正申請）
    -   `$breakCorrection->stampCorrectionRequest` でアクセス

**実装**:

```php
// BreakCorrection.php
public function stampCorrectionRequest() {
    return $this->belongsTo(StampCorrectionRequest::class);
}
```

---

## リレーション図

```
User (1)
  │
  ├──> (1) Role
  │
  ├──< (多) Attendance (1)
  │         │
  │         ├──< (多) BreakTime
  │         │
  │         └──< (多) StampCorrectionRequest (1)
  │                     │
  │                     └──< (多) BreakCorrection
  │
  └──< (多) StampCorrectionRequest (申請者として、attendance経由)
```

---

## 外部キー制約の詳細

### 外部キー（FK）カラム一覧

本アプリケーションで使用されているすべての外部キーカラム：

| テーブル                    | 外部キーカラム名              | 型           | 制約         | 参照先テーブル              | 参照先カラム | ON DELETE | 説明                     |
| --------------------------- | ----------------------------- | ------------ | ------------ | --------------------------- | ------------ | --------- | ------------------------ |
| `users`                     | `role_id`                     | unsigned int | NOT NULL, FK | `roles`                     | `id`         | RESTRICT  | ユーザーのロール         |
| `attendances`               | `user_id`                     | unsigned int | NOT NULL, FK | `users`                     | `id`         | CASCADE   | 勤怠を登録したユーザー   |
| `break_times`               | `attendance_id`               | unsigned int | NOT NULL, FK | `attendances`               | `id`         | CASCADE   | どの勤怠の休憩か         |
| `stamp_correction_requests` | `attendance_id`               | unsigned int | NOT NULL, FK | `attendances`               | `id`         | CASCADE   | どの勤怠の修正申請か     |
| `break_corrections`         | `stamp_correction_request_id` | unsigned int | NOT NULL, FK | `stamp_correction_requests` | `id`         | CASCADE   | どの修正申請の休憩修正か |

### 外部キー制約の詳細（簡易版）

| テーブル                    | 外部キー                      | 参照先テーブル              | ON DELETE | 説明                     |
| --------------------------- | ----------------------------- | --------------------------- | --------- | ------------------------ |
| `users`                     | `role_id`                     | `roles`                     | RESTRICT  | ユーザーのロール         |
| `attendances`               | `user_id`                     | `users`                     | CASCADE   | 勤怠を登録したユーザー   |
| `break_times`               | `attendance_id`               | `attendances`               | CASCADE   | どの勤怠の休憩か         |
| `stamp_correction_requests` | `attendance_id`               | `attendances`               | CASCADE   | どの勤怠の修正申請か     |
| `break_corrections`         | `stamp_correction_request_id` | `stamp_correction_requests` | CASCADE   | どの修正申請の休憩修正か |

### ON DELETE の動作

-   **CASCADE**: 親レコードが削除されると、子レコードも自動的に削除される
-   **RESTRICT**: 親レコードが削除されようとした場合、子レコードが存在すると削除を拒否する

**例**:

-   ユーザーを削除 → そのユーザーの勤怠レコードも自動削除（CASCADE）
-   ロールを削除 → そのロールを使用しているユーザーが存在する場合は削除拒否（RESTRICT）

---

## データ型の詳細

### 日付・時刻型

| カラム名                     | 型        | 説明                         |
| ---------------------------- | --------- | ---------------------------- |
| `date`                       | date      | 日付のみ（Y-m-d 形式）       |
| `clock_in_time`              | datetime  | 出勤日時（Y-m-d H:i:s 形式） |
| `clock_out_time`             | datetime  | 退勤日時（Y-m-d H:i:s 形式） |
| `break_start_time`           | datetime  | 休憩開始日時                 |
| `break_end_time`             | datetime  | 休憩終了日時                 |
| `requested_clock_in_time`    | datetime  | 申請された出勤日時           |
| `requested_clock_out_time`   | datetime  | 申請された退勤日時           |
| `requested_break_start_time` | datetime  | 申請された休憩開始日時       |
| `requested_break_end_time`   | datetime  | 申請された休憩終了日時       |
| `approved_at`                | timestamp | 承認日時                     |
| `email_verified_at`          | timestamp | メール認証日時（未使用）     |
| `created_at`                 | timestamp | 作成日時                     |
| `updated_at`                 | timestamp | 更新日時                     |

### 文字列型

| カラム名         | 型           | 最大長 | 説明           |
| ---------------- | ------------ | ------ | -------------- |
| `name`           | varchar(255) | 255    | ユーザー名     |
| `email`          | varchar(255) | 255    | メールアドレス |
| `password`       | varchar(255) | 255    | パスワード     |
| `role.name`      | varchar(255) | 255    | ロール名       |
| `role.label`     | varchar(255) | 255    | ロール表示名   |
| `note`           | varchar(500) | 500    | 備考           |
| `requested_note` | varchar(500) | 500    | 申請された備考 |

### 数値型

| カラム名                      | 型           | 説明                           |
| ----------------------------- | ------------ | ------------------------------ |
| `id`                          | unsigned int | 主キー（自動増分）             |
| `user_id`                     | unsigned int | ユーザー ID                    |
| `role_id`                     | unsigned int | ロール ID                      |
| `attendance_id`               | unsigned int | 勤怠 ID                        |
| `status`                      | unsigned int | ステータス値（0-3 または 0-2） |
| `stamp_correction_request_id` | unsigned int | 修正申請 ID                    |

---

## ユニーク制約

### users テーブル

-   `email` - メールアドレスの重複を防止

### roles テーブル

-   `name` - ロール名の重複を防止

### attendances テーブル

-   `user_id` + `date` - 1 ユーザー 1 日 1 レコードを保証

---

## インデックス

### 主キーインデックス

すべてのテーブルで`id`カラムに主キーインデックスが設定されています。

### ユニークインデックス

-   `users.email`
-   `roles.name`
-   `attendances` (`user_id`, `date`) の複合ユニークインデックス

### 外部キーインデックス

外部キー制約が設定されているカラムには、自動的にインデックスが作成されます：

-   `users.role_id`
-   `attendances.user_id`
-   `break_times.attendance_id`
-   `stamp_correction_requests.attendance_id`
-   `break_corrections.stamp_correction_request_id`

---

## マイグレーション実行順序

マイグレーションファイルは以下の順序で実行されます：

1. `2014_10_12_000000_create_users_table.php` - users テーブル作成（初期状態：role カラム）
2. `2014_10_12_100000_create_password_resets_table.php` - password_resets テーブル作成
3. `2019_08_19_000000_create_failed_jobs_table.php` - failed_jobs テーブル作成
4. `2019_12_14_000001_create_personal_access_tokens_table.php` - personal_access_tokens テーブル作成
5. `2025_11_12_181409_create_attendances_table.php` - attendances テーブル作成
6. `2025_11_12_181415_create_break_times_table.php` - break_times テーブル作成
7. `2025_11_12_181421_create_stamp_correction_requests_table.php` - stamp_correction_requests テーブル作成
8. `2025_11_12_181426_create_break_corrections_table.php` - break_corrections テーブル作成
9. `2025_11_27_200000_create_roles_table.php` - roles テーブル作成（初期データ投入含む）
10. `2025_11_27_200001_change_users_table_role_to_role_id.php` - users テーブル変更（role → role_id）

**重要**: マイグレーションは日時順に実行されるため、`roles`テーブルが先に作成され、その後`users`テーブルが変更されます。

---

## データ整合性の保証

### 外部キー制約による整合性

-   `users.role_id` → `roles.id` (RESTRICT)

    -   存在しないロール ID を設定できない
    -   ロールを削除する際、そのロールを使用しているユーザーが存在する場合は削除できない

-   `attendances.user_id` → `users.id` (CASCADE)

    -   存在しないユーザー ID を設定できない
    -   ユーザーを削除すると、そのユーザーの勤怠レコードも自動削除

-   `break_times.attendance_id` → `attendances.id` (CASCADE)

    -   存在しない勤怠 ID を設定できない
    -   勤怠を削除すると、その勤怠の休憩レコードも自動削除

-   `stamp_correction_requests.attendance_id` → `attendances.id` (CASCADE)

    -   存在しない勤怠 ID を設定できない
    -   勤怠を削除すると、その勤怠の修正申請レコードも自動削除

-   `break_corrections.stamp_correction_request_id` → `stamp_correction_requests.id` (CASCADE)
    -   存在しない修正申請 ID を設定できない
    -   修正申請を削除すると、その修正申請の休憩修正レコードも自動削除

### ユニーク制約による整合性

-   `users.email` - メールアドレスの重複を防止
-   `roles.name` - ロール名の重複を防止
-   `attendances` (`user_id`, `date`) - 1 ユーザー 1 日 1 レコードを保証

---

## モデルファイル一覧

| モデル名                 | ファイルパス                            | テーブル名                  |
| ------------------------ | --------------------------------------- | --------------------------- |
| `User`                   | `app/Models/User.php`                   | `users`                     |
| `Role`                   | `app/Models/Role.php`                   | `roles`                     |
| `Attendance`             | `app/Models/Attendance.php`             | `attendances`               |
| `BreakTime`              | `app/Models/BreakTime.php`              | `break_times`               |
| `StampCorrectionRequest` | `app/Models/StampCorrectionRequest.php` | `stamp_correction_requests` |
| `BreakCorrection`        | `app/Models/BreakCorrection.php`        | `break_corrections`         |

---

## 使用例

### ユーザーのロールを取得

```php
$user = User::with('role')->find(1);
echo $user->role->name;  // 'user' or 'admin'
echo $user->role->label; // '一般ユーザー' or '管理者'

// ヘルパーメソッドを使用
if ($user->isAdmin()) {
    // 管理者の処理
}
```

### ユーザーの勤怠一覧を取得

```php
$user = User::find(1);
$attendances = $user->attendances;

foreach ($attendances as $attendance) {
    echo $attendance->date;
    echo $attendance->clock_in_time;
}
```

### 勤怠の休憩一覧を取得

```php
$attendance = Attendance::with('breaks')->find(1);
$breaks = $attendance->breaks;

foreach ($breaks as $break) {
    echo $break->break_start_time;
    echo $break->break_end_time;
}
```

### ユーザーの修正申請一覧を取得

```php
$user = User::find(1);
$requests = $user->stampCorrectionRequests;

foreach ($requests as $request) {
    echo $request->status;
    echo $request->attendance->date;
}
```

---

## 参考資料

-   **テーブルリレーション**: `docs/仕様/テーブルリレーション.md`
-   **ロール管理パターン比較**: `docs/仕様/ロール管理パターン比較.md`
-   **ユーザーロール仕様**: `docs/仕様/ユーザーロール仕様.md`
-   **勤怠ステータス**: `docs/仕様/勤怠ステータス.md`
-   **修正申請ステータス**: `docs/仕様/修正申請ステータス.md`

---

## 更新履歴

-   **2025 年 11 月 27 日**: roles テーブルを追加、users テーブルの role カラムを role_id に変更
-   **2025 年 11 月 12 日**: 初期テーブル設計（users, attendances, break_times, stamp_correction_requests, break_corrections）
