# テーブルリレーション

## 概要

勤怠管理アプリの各テーブル間のリレーション（関連）をまとめたドキュメントです。

---

## リレーション一覧

### 1. User（ユーザー）モデル

**リレーション**:

-   `hasMany` → `Attendance`（1 ユーザー：0 件以上または複数勤怠）
    -   1 人のユーザーに対して 0 件以上の勤怠レコードが存在可能（0 件も複数件も可能）
-   `hasMany` → `StampCorrectionRequest`（申請者として）
    -   1 人のユーザーに対して複数の修正申請レコードが存在可能（`user_id`で紐づく）
-   `hasMany` → `StampCorrectionRequest`（承認者として）
    -   1 人の管理者に対して複数の承認済み修正申請レコードが存在可能（`approved_by`で紐づく）

**実装**:

```php
// User.php
public function attendances()
{
    return $this->hasMany(Attendance::class);
}

public function stampCorrectionRequests()
{
    return $this->hasMany(StampCorrectionRequest::class, 'user_id');
}

public function approvedStampCorrectionRequests()
{
    return $this->hasMany(StampCorrectionRequest::class, 'approved_by');
}
```

---

### 2. Attendance（勤怠）モデル

**リレーション**:

-   `belongsTo` → `User`（1 勤怠：1 ユーザー）
    -   1 つの勤怠レコードは 1 人のユーザーに紐づく
-   `hasMany` → `BreakTime`（1 勤怠：複数休憩）
    -   1 つの勤怠レコードに対して複数の休憩レコードが存在可能（1 日に複数回休憩可能）
-   `hasMany` → `StampCorrectionRequest`（1 勤怠：複数修正申請）
    -   1 つの勤怠レコードに対して複数の修正申請レコードが存在可能

**実装**:

```php
// Attendance.php
public function user()
{
    return $this->belongsTo(User::class);
}

public function breaks()
{
    return $this->hasMany(BreakTime::class);
}

public function stampCorrectionRequests()
{
    return $this->hasMany(StampCorrectionRequest::class);
}
```

---

### 3. BreakTime（休憩時間）モデル

**リレーション**:

-   `belongsTo` → `Attendance`（1 休憩：1 勤怠）
    -   1 つの休憩レコードは 1 つの勤怠レコードに紐づく

**実装**:

```php
// BreakTime.php
public function attendance()
{
    return $this->belongsTo(Attendance::class);
}
```

---

### 4. StampCorrectionRequest（修正申請）モデル

**リレーション**:

-   `belongsTo` → `Attendance`（1 修正申請：1 勤怠）
    -   1 つの修正申請レコードは 1 つの勤怠レコードに紐づく
-   `belongsTo` → `User`（申請者）
    -   1 つの修正申請レコードは 1 人の申請者（ユーザー）に紐づく（`user_id`）
-   `belongsTo` → `User`（承認者）
    -   1 つの修正申請レコードは 1 人の承認者（管理者）に紐づく（`approved_by`）
-   `hasMany` → `BreakCorrection`（1 修正申請：複数休憩修正）
    -   1 つの修正申請レコードに対して複数の休憩修正レコードが存在可能（1 日に複数回休憩があるため）

**実装**:

```php
// StampCorrectionRequest.php
public function attendance()
{
    return $this->belongsTo(Attendance::class);
}

public function user()
{
    return $this->belongsTo(User::class, 'user_id');
}

public function approver()
{
    return $this->belongsTo(User::class, 'approved_by');
}

public function breakCorrections()
{
    return $this->hasMany(BreakCorrection::class);
}
```

---

### 5. BreakCorrection（休憩修正）モデル

**リレーション**:

-   `belongsTo` → `StampCorrectionRequest`（1 休憩修正：1 修正申請）
    -   1 つの休憩修正レコードは 1 つの修正申請レコードに紐づく

**実装**:

```php
// BreakCorrection.php
public function stampCorrectionRequest()
{
    return $this->belongsTo(StampCorrectionRequest::class);
}
```

---

## リレーション図

```
User (1)
  │
  ├──< (多) Attendance (1)
  │         │
  │         ├──< (多) BreakTime
  │         │
  │         └──< (多) StampCorrectionRequest (1)
  │                     │
  │                     ├──< (多) BreakCorrection
  │                     │
  │                     ├──> (1) User (申請者)
  │                     │
  │                     └──> (1) User (承認者)
  │
  ├──< (多) StampCorrectionRequest (申請者として)
  │
  └──< (多) StampCorrectionRequest (承認者として)
```

---

## リレーションの種類

### hasMany（1 対多）

-   1 つの親レコードに対して複数の子レコードが存在可能
-   例：1 ユーザー → 複数勤怠、1 勤怠 → 複数休憩

### belongsTo（多対 1）

-   複数の子レコードが 1 つの親レコードに紐づく
-   例：複数勤怠 → 1 ユーザー、複数休憩 → 1 勤怠

---

## 外部キー

| テーブル                    | 外部キー                      | 参照先テーブル              | 説明                     |
| --------------------------- | ----------------------------- | --------------------------- | ------------------------ |
| `attendances`               | `user_id`                     | `users`                     | 勤怠を登録したユーザー   |
| `break_times`               | `attendance_id`               | `attendances`               | どの勤怠の休憩か         |
| `stamp_correction_requests` | `attendance_id`               | `attendances`               | どの勤怠の修正申請か     |
| `stamp_correction_requests` | `user_id`                     | `users`                     | 申請者（一般ユーザー）   |
| `stamp_correction_requests` | `approved_by`                 | `users`                     | 承認者（管理者）         |
| `break_corrections`         | `stamp_correction_request_id` | `stamp_correction_requests` | どの修正申請の休憩修正か |

---

## 使用例

### ユーザーの勤怠一覧を取得

```php
$user = User::find(1);
$attendances = $user->attendances; // そのユーザーの全勤怠レコード
```

### 勤怠の休憩一覧を取得

```php
$attendance = Attendance::find(1);
$breaks = $attendance->breaks; // その勤怠の全休憩レコード
```

### 修正申請の休憩修正一覧を取得

```php
$request = StampCorrectionRequest::find(1);
$breakCorrections = $request->breakCorrections; // その修正申請の全休憩修正レコード
```

### 申請者と承認者の情報を取得

```php
$request = StampCorrectionRequest::find(1);
$applicant = $request->user;      // 申請者（User）
$approver = $request->approver;    // 承認者（User、nullの可能性あり）
```

---

## 注意点

1. **1 対多の関係**

    - 1 つの勤怠に対して複数の休憩レコードが存在可能（FN021: 休憩は 1 日に何回でも押下できる）
    - 1 つの修正申請に対して複数の休憩修正レコードが存在可能

2. **User モデルの複数のリレーション**

    - `StampCorrectionRequest`に対して 2 つのリレーションがある
        - `stampCorrectionRequests()`: 申請者として（`user_id`）
        - `approvedStampCorrectionRequests()`: 承認者として（`approved_by`）

3. **外部キー制約**
    - マイグレーションファイルで`onDelete('cascade')`が設定されている場合、親レコード削除時に子レコードも自動削除される
