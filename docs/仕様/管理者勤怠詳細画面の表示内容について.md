# 管理者勤怠詳細画面の表示内容について

## 概要

管理者の勤怠詳細画面（US011）と管理者の修正申請詳細画面（US015）では、表示すべき内容が異なります。本ドキュメントでは、各画面で表示すべき内容とその根拠を整理します。

---

## 機能要件の確認

### US011: 管理者ユーザーは各勤怠の詳細を確認・修正することができる

| 要件 ID | 機能一覧           | 機能詳細（完了状態）                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ------- | ------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| FN037   | 詳細情報取得機能   | 1. 詳細画面の内容が，動線上で自分が選択した情報と一致していること<br>2. **詳細画面の内容が，正しく実際の勤怠内容が反映されていること**                                                                                                                                                                                                                                                                                                                                                                                                             |
| FN038   | 項目編集機能       | 「出勤・退勤」「休憩」「備考」の 4 つの項目において，修正したい内容を記載できるフィールドになっていること<br><br>「承認待ち」の申請詳細は，修正を行うことができず，<br>「承認待ちのため修正はできません。」とメッセージが表示されていること                                                                                                                                                                                                                                                                                                        |
| FN039   | バリデーション機能 | 1. 出勤時間が退勤時間より後になっている場合，および退勤時間が出勤時間より前になっている場合に以下のメッセージを表示<br>　・出勤時間もしくは退勤時間が不適切な値です<br><br>2. 休憩開始時間が出勤時間より前になっている場合及び退勤時間より後になっている場合、以下のメッセージを表示<br>　・休憩時間が不適切な値です<br><br>3. 休憩終了時間が退勤時間より後になっている場合、以下のメッセージを表示<br>　・休憩時間もしくは退勤時間が不適切な値です<br><br>4. 備考欄が未入力になっている際に，以下のメッセージを表示<br>　・備考を記入してください |
| FN040   | 修正機能           | 1. 「修正」ボタンを押下すると，管理者として直接修正が実行されること<br>2. 修正された内容は一般ユーザーの勤怠情報としても反映されていること                                                                                                                                                                                                                                                                                                                                                                                                         |

**引用元**: `docs/仕様/機能要件一覧.md` (US011)

---

### US015: 管理者ユーザーは修正申請の詳細を確認 / 承認することができる

| 要件 ID | 機能一覧         | 機能詳細（完了状態）                                                                                                                                                                                                                                                                              |
| ------- | ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| FN050   | 申請詳細取得機能 | 1. 詳細画面の内容が，動線上で自分が選択した情報と一致していること<br>2. **詳細画面の内容が，正しく実際の打刻内容が反映されていること**                                                                                                                                                            |
| FN051   | 承認機能         | 「承認」を行うと以下の振る舞いをすること<br><br>1. 管理者ユーザーの「修正申請一覧」で，"承認待ち"から"承認済み"に変更されていること<br>2. 一般ユーザーの当該勤怠情報が更新され，修正申請の内容と一致すること<br>3. 一般ユーザーの「修正申請一覧」で，"承認待ち"から"承認済み"に変更されていること |

**引用元**: `docs/仕様/機能要件一覧.md` (US015)

---

## 表示内容の整理

### 管理者勤怠詳細画面（US011）

**表示すべき内容**: **実際の勤怠データ**

-   **データソース**: `attendances`テーブル、`break_times`テーブル
-   **根拠**: FN037「正しく実際の勤怠内容が反映されていること」
-   **承認待ちの修正申請がある場合**:
    -   実際の勤怠データを表示（修正申請の内容は表示しない）
    -   修正不可（「承認待ちのため修正はできません。」とメッセージ表示）
    -   修正申請の内容は、修正申請詳細画面（US015）で確認する

### 管理者修正申請詳細画面（US015）

**表示すべき内容**: **修正申請の内容（`requested_*`）**

-   **データソース**: `stamp_correction_requests`テーブル、`break_corrections`テーブル
-   **根拠**: FN050「正しく実際の打刻内容が反映されていること」（修正申請の内容を指す）
-   **承認処理**: FN051 により、承認時に修正申請の内容が実際の勤怠データに反映される

---

## 実装方針

### 管理者勤怠詳細画面の実装

```php
// Admin/AttendanceController@show
public function show($id)
{
    // 勤怠レコードを取得
    $attendance = Attendance::with(['user', 'breaks', 'stampCorrectionRequests'])
        ->findOrFail($id);

    // 承認待ちの修正申請があるかチェック
    $hasPendingRequest = $attendance->stampCorrectionRequests()
        ->where('status', StampCorrectionRequest::STATUS_PENDING)
        ->exists();

    // 実際の勤怠データを表示（FN037に準拠）
    // 承認待ちの修正申請がある場合でも、実際の勤怠データを表示
    $data = $this->prepareAttendanceDetailData($attendance, false);

    $data['hasPendingRequest'] = $hasPendingRequest;
    $data['canEdit'] = !$hasPendingRequest;

    return view('admin.attendance.detail', $data);
}
```

**ポイント**:

-   `prepareAttendanceDetailData($attendance, false)` を使用
-   `checkPendingRequest = false` により、承認待ちの修正申請の内容（`requested_*`）は表示しない
-   実際の勤怠データ（`attendance->clock_in_time`, `attendance->clock_out_time`, `attendance->note`, `attendance->breaks`）を表示

### 管理者修正申請詳細画面の実装（未実装）

```php
// Admin/StampCorrectionRequestController@show（実装予定）
public function show($id)
{
    // 修正申請レコードを取得
    $stampCorrectionRequest = StampCorrectionRequest::with([
        'attendance.user',
        'breakCorrections'
    ])->findOrFail($id);

    // 修正申請の内容（requested_*）を表示（FN050に準拠）
    return view('admin.stamp_correction_request.detail', [
        'stampCorrectionRequest' => $stampCorrectionRequest,
        // 修正申請の内容を表示
        'displayClockInTime' => $stampCorrectionRequest->requested_clock_in_time?->format('H:i'),
        'displayClockOutTime' => $stampCorrectionRequest->requested_clock_out_time?->format('H:i'),
        'displayNote' => $stampCorrectionRequest->requested_note,
        'breakCorrections' => $stampCorrectionRequest->breakCorrections,
    ]);
}
```

---

## 表示内容の比較表

| 画面                                | 表示内容         | データソース                                       | 機能要件                                  | 承認待ちの修正申請がある場合       |
| ----------------------------------- | ---------------- | -------------------------------------------------- | ----------------------------------------- | ---------------------------------- |
| **管理者勤怠詳細画面（US011）**     | 実際の勤怠データ | `attendances`<br>`break_times`                     | FN037: 実際の勤怠内容が反映されていること | 実際の勤怠データを表示<br>修正不可 |
| **管理者修正申請詳細画面（US015）** | 修正申請の内容   | `stamp_correction_requests`<br>`break_corrections` | FN050: 実際の打刻内容が反映されていること | 修正申請の内容を表示<br>承認可能   |

---

## 修正申請の承認フロー

1. **修正申請の作成**（一般ユーザー）

    - 一般ユーザーが勤怠詳細画面で修正申請を作成
    - `stamp_correction_requests`テーブルに`status = 0`（承認待ち）で保存

2. **修正申請の確認**（管理者）

    - 管理者が修正申請一覧画面（US014）で承認待ちの申請を確認
    - 修正申請詳細画面（US015）で修正申請の内容（`requested_*`）を確認

3. **承認処理**（管理者）

    - 管理者が修正申請詳細画面で「承認」ボタンを押下
    - FN051 により、修正申請の内容が実際の勤怠データに反映される
        - `stamp_correction_requests.requested_clock_in_time` → `attendances.clock_in_time`
        - `stamp_correction_requests.requested_clock_out_time` → `attendances.clock_out_time`
        - `stamp_correction_requests.requested_note` → `attendances.note`
        - `break_corrections.requested_break_start_time` → `break_times.break_start_time`
        - `break_corrections.requested_break_end_time` → `break_times.break_end_time`
    - `stamp_correction_requests.status = 1`（承認済み）に更新

4. **承認後の確認**（管理者・一般ユーザー）
    - 管理者の勤怠詳細画面（US011）で、更新された実際の勤怠データを確認
    - 一般ユーザーの勤怠詳細画面で、更新された実際の勤怠データを確認

---

## まとめ

-   **管理者勤怠詳細画面（US011）**: 常に実際の勤怠データを表示（FN037 に準拠）
-   **管理者修正申請詳細画面（US015）**: 修正申請の内容を表示（FN050 に準拠）
-   承認待ちの修正申請がある場合でも、管理者勤怠詳細画面では実際の勤怠データを表示し、修正申請の内容は修正申請詳細画面で確認する
