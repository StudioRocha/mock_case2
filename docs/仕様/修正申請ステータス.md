# 修正申請ステータスについて

## 概要

勤怠管理アプリにおける修正申請（`stamp_correction_requests`テーブル）のステータス定義、使用タイミング、遷移フローをまとめたドキュメントです。

---

## ステータス定義

`StampCorrectionRequest`モデルで定義されている 3 つのステータス定数：

| 定数名            | 値  | ラベル   | 説明                                             |
| ----------------- | --- | -------- | ------------------------------------------------ |
| `STATUS_PENDING`  | 0   | 承認待ち | 申請を提出したが、まだ管理者が承認していない状態 |
| `STATUS_APPROVED` | 1   | 承認済み | 管理者が承認した状態                             |
| `STATUS_REJECTED` | 2   | 却下     | 管理者が却下した状態                             |

**定義場所**: `src/app/Models/StampCorrectionRequest.php`

```php
public const STATUS_PENDING = 0;  // 承認待ち
public const STATUS_APPROVED = 1;  // 承認済み
public const STATUS_REJECTED = 2;  // 却下
```

---

## データベース設計

### カラム定義

| カラム名      | 型          | NOT NULL | 説明                                       |
| ------------- | ----------- | -------- | ------------------------------------------ |
| `status`      | `integer`   | ○        | 修正申請のステータス（0, 1, 2 のいずれか） |
| `approved_at` | `timestamp` | -        | 承認日時（承認済みの場合のみ値が入る）     |

**マイグレーションファイル**: `database/migrations/2025_11_12_181421_create_stamp_correction_requests_table.php`

```php
$table->integer('status');
$table->timestamp('approved_at')->nullable();
```

### なぜ整数型を使うのか

1. **パフォーマンス**: 数値比較が文字列比較より高速
2. **ストレージ効率**: 文字列型（`varchar`）より少ない容量で保存できる
3. **拡張性**: 将来ステータスを追加する際も数値を追加するだけ
4. **多言語対応**: 表示用の文字列はコード側で管理し、データベースには数値のみ保存

---

## 各ステータスの詳細

### 1. STATUS_PENDING (0) - 承認待ち

**意味**: ユーザーが修正申請を提出したが、まだ管理者が承認していない状態

**初期状態**: 修正申請を作成した時点で自動的に`0`（承認待ち）が設定される

**データベースへの保存**:

-   `status = 0`
-   `approved_at = NULL`

**画面表示**:

-   一般ユーザーの「申請一覧画面」の「承認待ち」タブに表示される（FN031）
-   管理者の「申請一覧画面」の「承認待ち」タブに表示される（FN047）
-   状態欄に「承認待ち」と表示される

**制約**:

-   この状態の申請は修正できない（FN027, FN038）
-   勤怠詳細画面で「承認待ちのため修正はできません。」というメッセージが表示される

**実装箇所**:

-   `CorrectionRequestController@list()`: ステータスでフィルタリング
-   `resources/views/stamp_correction_request/list.blade.php`: タブ表示とフィルタリング
-   `resources/views/attendance/detail.blade.php`: 修正不可の判定

---

### 2. STATUS_APPROVED (1) - 承認済み

**意味**: 管理者が修正申請を承認した状態

**遷移タイミング**: 管理者が「修正申請承認画面」で「承認」ボタンを押下した時（FN051）

**データベースへの保存**:

-   `status = 1`
-   `approved_at = 承認日時`（現在のタイムスタンプ）

**画面表示**:

-   一般ユーザーの「申請一覧画面」の「承認済み」タブに表示される（FN032）
-   管理者の「申請一覧画面」の「承認済み」タブに表示される（FN048）
-   状態欄に「承認済み」と表示される

**処理内容**:

-   承認時に、修正申請の内容が実際の勤怠データに反映される（FN051）
    -   `attendances`テーブルの`clock_in_time`, `clock_out_time`, `note`が更新される
    -   `break_times`テーブルに休憩修正が反映される（`break_corrections`テーブル経由）

**実装箇所**:

-   `Admin/StampCorrectionRequestController@processApprove()`: 承認処理（未実装）
-   `CorrectionRequestController@list()`: ステータスでフィルタリング

---

### 3. STATUS_REJECTED (2) - 却下

**意味**: 管理者が修正申請を却下した状態

**遷移タイミング**: 管理者が「修正申請承認画面」で「却下」ボタンを押下した時（実装予定）

**データベースへの保存**:

-   `status = 2`
-   `approved_at = NULL`（却下の場合は承認日時は記録しない）

**画面表示**:

-   状態欄に「却下」と表示される
-   現在の実装では、却下機能は未実装（将来の拡張用）

**処理内容**:

-   却下された申請は、勤怠データに反映されない
-   ユーザーは再度修正申請を行う必要がある

---

## ステータス遷移フロー

```
┌─────────────────┐
│  修正申請作成   │
│  (勤怠詳細画面) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ [0: 承認待ち]   │ ← 初期状態
│ STATUS_PENDING  │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌─────────┐ ┌─────────┐
│ 承認    │ │ 却下    │
│ (管理者)│ │ (管理者)│
└────┬────┘ └────┬────┘
     │           │
     ▼           ▼
┌─────────┐ ┌─────────┐
│[1:承認済]│ │[2:却下] │
│STATUS_  │ │STATUS_  │
│APPROVED │ │REJECTED │
└─────────┘ └─────────┘
     │
     ▼
┌─────────────────┐
│ 勤怠データ更新  │
│ (attendances,   │
│  break_times)   │
└─────────────────┘
```

---

## 実装例

### 1. コントローラーでの使用

```php
// CorrectionRequestController.php
public function list(Request $request)
{
    $status = $request->get('status', 'pending');

    $query = StampCorrectionRequest::whereHas('attendance', function ($q) {
            $q->where('user_id', Auth::id());
        })
        ->with(['attendance.user'])
        ->orderBy('created_at', 'desc');

    // ステータスでフィルタリング
    if ($status === 'pending') {
        $query->where('status', StampCorrectionRequest::STATUS_PENDING);
    } elseif ($status === 'approved') {
        $query->where('status', StampCorrectionRequest::STATUS_APPROVED);
    }

    $requests = $query->paginate(10);

    return view('stamp_correction_request.list', [
        'requests' => $requests,
        'currentStatus' => $status,
    ]);
}
```

### 2. ビューでの表示

```blade
{{-- stamp_correction_request/list.blade.php --}}
<td class="stamp-correction-request-list-table__cell">
    @if($request->status === \App\Models\StampCorrectionRequest::STATUS_PENDING)
        承認待ち
    @elseif($request->status === \App\Models\StampCorrectionRequest::STATUS_APPROVED)
        承認済み
    @else
        却下
    @endif
</td>
```

### 3. 修正可否の判定

```blade
{{-- attendance/detail.blade.php --}}
@if($hasPendingRequest)
<div class="attendance-detail-message attendance-detail-message--error attendance-detail-message--pending">
    承認待ちのため修正はできません。
</div>
@endif
```

---

## データベースでの保存例

| id  | attendance_id | status | approved_at           | 意味                                             |
| --- | ------------- | ------ | --------------------- | ------------------------------------------------ |
| 1   | 100           | `0`    | `NULL`                | 承認待ち                                         |
| 2   | 101           | `1`    | `2023-06-15 10:30:00` | 承認済み（2023 年 6 月 15 日 10 時 30 分に承認） |
| 3   | 102           | `2`    | `NULL`                | 却下                                             |

---

## 関連機能要件

### FN031: 承認待ち情報取得機能

-   "承認待ち"には、自分が行った申請のうち、管理者が承認していないものが全て表示される
-   `status = 0`のレコードを取得

### FN032: 承認済み情報取得機能

-   "承認済み"には、管理者が承認した修正申請が全て表示される
-   `status = 1`のレコードを取得

### FN047: 承認待ち情報取得機能（管理者）

-   "承認待ち"には全ての一般ユーザーが行った未承認の修正申請が全て表示される
-   `status = 0`のレコードを取得

### FN048: 承認済み情報取得機能（管理者）

-   "承認済み"には、全ての一般ユーザーが行った、これまでの承認済みの修正申請が全て表示される
-   `status = 1`のレコードを取得

### FN051: 承認機能

-   「承認」を行うと、`status`が`0`から`1`に変更される
-   `approved_at`に承認日時が記録される
-   一般ユーザーの当該勤怠情報が更新され、修正申請の内容と一致する

---

## 注意事項

1. **定数の使用**: コード内では数値（`0`, `1`, `2`）を直接書かず、必ず定数（`STATUS_PENDING`, `STATUS_APPROVED`, `STATUS_REJECTED`）を使用すること

2. **ステータス変更の権限**:

    - 一般ユーザーはステータスを変更できない（申請作成時のみ`0`が設定される）
    - 管理者のみがステータスを変更できる（承認・却下処理）

3. **承認済みの再申請**: 承認済み（`status = 1`）の申請は、再度修正申請を行うことはできない（1 つの勤怠に対して複数の申請は可能だが、承認済みの申請は変更不可）

4. **却下機能**: 現在の実装では却下機能（`status = 2`）は未実装。将来の拡張用に定義されている

---

## まとめ

-   `status`カラムは`integer`型で、修正申請の状態を管理する
-   `0`=承認待ち、`1`=承認済み、`2`=却下の 3 つの状態がある
-   定数で管理し、コード内では定数を使用する
-   画面では数値ではなく「承認待ち」「承認済み」「却下」などの文字列を表示する
-   この設計により、修正申請の承認ワークフローを効率的に管理できる
