# 編集ロックの仕組み

## 概要

勤怠詳細画面において、承認待ちの修正申請がある場合に編集をロックする仕組みについて説明します。

---

## 編集ロックの条件

修正申請のステータスが**0（承認待ち）**の場合、勤怠詳細画面で編集がロックされます。

| 修正申請のステータス | 値 | 編集可否 | 説明 |
|---------------------|-----|---------|------|
| 承認待ち | 0 | ロック（編集不可） | `canEdit = false`、`disabled`属性、バリデーションで拒否 |
| 承認済み | 1 | ロック解除（編集可能） | `canEdit = true`、編集可能 |

---

## 多層防御の仕組み

編集ロックは、3層の防御で実装されています。

### 【1層目】フロントエンド

**実装**: `disabled`属性で入力フィールドを無効化

```blade
@if(!$canEdit) disabled @endif
```

**役割**: ユーザーが編集できないようにする

**回避可能性**: ブラウザの開発者ツールで`disabled`属性を削除すれば回避可能

---

### 【2層目】FormRequest（バリデーション）

**実装**: FormRequestで承認待ちをチェックし、エラーを返す

```php
// ValidatesAttendanceDataトレイト
if ($hasPendingRequest) {
    $validator->errors()->add('pending_request', '*承認待ちのため修正はできません。');
}
```

**役割**: リクエストをバリデーションで拒否

**実行タイミング**: コントローラーのメソッドが実行される前

**失敗時の動作**: 自動的にリダイレクト + エラーメッセージ表示

---

### 【3層目】コントローラー

**実装**: `update`メソッドで承認待ちをチェックし、リダイレクト

```php
// Admin\AttendanceController@update
if ($hasPendingRequest) {
    return redirect()->route('admin.attendance.show', ['id' => $id])
        ->with('error', '*承認待ちのため修正はできません。');
}
```

**役割**: 処理前に再チェックして拒否

**実行タイミング**: バリデーション通過後（通常は到達しない）

---

## 実際の動作イメージ

### 正常な場合（バリデーション成功）

```
PUT /admin/attendance/1
    ↓
バリデーション成功
    ↓
コントローラーのupdateメソッド実行
    ↓
データベース更新
    ↓
リダイレクト + 成功メッセージ
```

### バリデーション失敗の場合（承認待ち）

```
PUT /admin/attendance/1
    ↓
バリデーション失敗（承認待ち検出）
    ↓
コントローラーのupdateメソッドは実行されない
    ↓
自動的に前のページにリダイレクト（302）
    ↓
エラーメッセージを表示
「*承認待ちのため修正はできません。」
```

---

## バリデーション失敗時の動作

### エラーの種類

- **ページエラー（500）ではない**
- **バリデーションエラーとして処理される**
- HTTPステータスコード: **302（リダイレクト）**

### 具体的な動作フロー

```
【ユーザーが修正ボタンをクリック】
PUT /admin/attendance/1
    ↓
【FormRequest（バリデーション）】
承認待ちチェック → エラー検出
    ↓
【Laravelの自動処理】
1. コントローラーのメソッドを実行しない
2. 前のページ（admin.attendance.show）にリダイレクト
3. エラーメッセージをセッションに保存
4. 入力値をセッションに保存（old()で取得可能）
    ↓
【ビューでエラーメッセージを表示】
「*承認待ちのため修正はできません。」
```

### エラーメッセージの表示

```blade
{{-- バリデーションエラーメッセージの表示 --}}
@if($errors->any())
<div class="attendance-detail-message attendance-detail-message--error">
    <ul>
        @foreach($errors->all() as $error)
        <li>{{ $error }}</li>
        @endforeach
    </ul>
</div>
@endif
```

- `$errors`変数にエラーメッセージが入る
- ビューで`$errors->all()`で全エラーを取得
- エラーメッセージが画面に表示される

---

## まとめ

| 項目 | 説明 |
|------|------|
| **エラーの種類** | ページエラー（500）ではなく、バリデーションエラー |
| **HTTPステータス** | 302（リダイレクト） |
| **コントローラー** | メソッドは実行されない |
| **リダイレクト先** | 前のページ（リクエスト元のページ） |
| **エラーメッセージ** | セッションに保存され、ビューで表示される |
| **ユーザー体験** | ページがリロードされ、エラーメッセージが表示される |

---

## 結論

**ページエラーにはなりません。** バリデーションエラーとして処理され、前のページにリダイレクトされ、エラーメッセージが表示されます。

3層の防御により、フロントエンドを回避しても、サーバーサイドで2箇所（バリデーションとコントローラー）でブロックされます。

---

## 参考資料

- [修正申請ステータス.md](./修正申請ステータス.md)
- [機能要件一覧.md](./機能要件一覧.md)

---

## 更新履歴

| 日付 | 更新内容 | 更新者 |
|------|---------|--------|
| 2025-01-XX | 初版作成 | - |

