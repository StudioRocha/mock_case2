# 推奨作成順序

## 概要

勤怠管理アプリの画面・機能の推奨実装順序をまとめたドキュメントです。
依存関係を考慮し、段階的に実装を進めることで効率的に開発できます。

---

## フェーズ 1: 基盤整備

### 1. データベース設計・マイグレーション

-   [ ] テーブル設計の確認
-   [ ] マイグレーションファイルの作成（**依存関係に注意**）

    -   [ ] `roles` テーブルのマイグレーション（最初に作成）
        -   ファイル名例: `2025_11_27_200000_create_roles_table.php`
    -   [ ] `users` テーブルのマイグレーション（`roles` テーブルに依存）
        -   ファイル名例: `2025_11_27_200001_create_users_table.php`
        -   **注意**: `role_id` カラムに外部キー制約を設定（`roles.id` を参照）
    -   [ ] `attendances` テーブルのマイグレーション（`users` テーブルに依存）
        -   ファイル名例: `2025_11_27_200002_create_attendances_table.php`
    -   [ ] `break_times` テーブルのマイグレーション（`attendances` テーブルに依存）
        -   ファイル名例: `2025_11_27_200003_create_break_times_table.php`
    -   [ ] `stamp_correction_requests` テーブルのマイグレーション（`attendances` テーブルに依存）
        -   ファイル名例: `2025_11_27_200004_create_stamp_correction_requests_table.php`
    -   [ ] `break_corrections` テーブルのマイグレーション（`stamp_correction_requests` テーブルに依存）
        -   ファイル名例: `2025_11_27_200005_create_break_corrections_table.php`

    **重要**: マイグレーションファイルのタイムスタンプ（日時部分）で実行順序が決まります。依存関係に従って、タイムスタンプを適切に設定してください。

-   [ ] シーダーファイルの作成
    -   [ ] `RoleSeeder.php` の作成（ロールの初期データ：一般ユーザー、管理者）
    -   [ ] `DatabaseSeeder.php` に `RoleSeeder` を追加（**最初に実行**）
    -   [ ] `DatabaseSeeder.php` に管理者ユーザーを作成するコードを追加（`RoleSeeder` の後）

```php
// DatabaseSeeder.php
public function run()
{
    // ロールの初期データを作成（最初に実行）
    $this->call(RoleSeeder::class);

    // 管理者ユーザーを作成
    $adminRole = Role::where('name', Role::NAME_ADMIN)->firstOrFail();
    User::firstOrCreate(
        ['email' => 'admin@example.com'],
        [
            'name' => '管理者',
            'password' => Hash::make('password'),
            'role_id' => $adminRole->id,
        ]
    );
}
```

### 2. 共通コンポーネント・レイアウト

-   [ ] `resources/css/common.css` の作成
-   [ ] `resources/views/layouts/app.blade.php` の作成
-   [ ] `resources/views/components/header.blade.php` の作成
-   [ ] `resources/views/components/button.blade.php` の作成
-   [ ] `resources/views/components/form/input.blade.php` の作成
-   [ ] `resources/views/components/form/label.blade.php` の作成（必要に応じて）

---

## フェーズ 2: 認証機能（一般ユーザー）

**使用技術**: Fortify（FN001, FN006 を参照）

### 3. 会員登録機能（PG01）

-   [x] `RegisterController` の作成
-   [x] `routes/web.php` に `/register` ルート追加
-   [x] `resources/views/auth/register.blade.php` の作成
-   [x] バリデーション実装
-   [x] ユーザー登録処理の実装（**使用技術: Fortify**）
-   [x] 自動ログイン機能の実装

### 4. ログイン機能（PG02）

-   [x] `LoginController` の作成
-   [x] `routes/web.php` に `/login` ルート追加
-   [x] `resources/views/auth/login.blade.php` の作成
-   [x] 認証処理の実装（**使用技術: Fortify**）
-   [x] 認証ミドルウェアの設定

---

## フェーズ 3: 一般ユーザー向け勤怠機能

### 5. 勤怠登録画面（PG03）

-   [x] `AttendanceController` の作成
-   [x] `routes/web.php` に `/attendance` ルート追加
-   [x] `resources/views/attendance/index.blade.php` の作成
-   [x]打刻機能の実装（出勤・退勤）
-   [x] 休憩開始・終了機能の実装
-   [x]バリデーション実装

### 6. 勤怠一覧画面（PG04）

-   [x] `AttendanceController@list` メソッドの追加
-   [x] `routes/web.php` に `/attendance/list` ルート追加
-   [x] `resources/views/attendance/list.blade.php` の作成
-   [x] 一覧表示機能の実装

### 7. 勤怠詳細画面（PG05）

-   [x] `AttendanceController@detail` メソッドの追加
-   [x] `routes/web.php` に `/attendance/detail/{id}` ルート追加
-   [x] `resources/views/attendance/detail.blade.php` の作成
-   [x] 詳細表示機能の実装

### 8. 申請一覧画面（一般ユーザー）（PG06）

-   [x]`StampCorrectionRequestController` の作成
-   [x] `routes/web.php` に `/stamp_correction_request/list` ルート追加
-   [x]`resources/views/stamp_correction_request/list.blade.php` の作成
-   [x] 申請一覧表示機能の実装

---

## フェーズ 4: 管理者向け機能

**使用技術**: Fortify（FN014 を参照）

### 9. 管理者ログイン画面（PG07）

-   [x] `Admin/LoginController` の作成
-   [x] `routes/web.php` に `/admin/login` ルート追加
-   [x] `resources/views/admin/login.blade.php` の作成
-   [x] 管理者認証処理の実装（**使用技術: Fortify**）
-   [x] 管理者認証ミドルウェアの設定

### 10. 管理者勤怠一覧画面（PG08）

-   [x]`Admin/AttendanceController` の作成
-   [x] `routes/web.php` に `/admin/attendance/list` ルート追加
-   [x] `resources/views/admin/attendance/list.blade.php` の作成
-   [x] 全スタッフの勤怠一覧表示機能の実装

### 11. 管理者勤怠詳細画面（PG09）

**機能要件**: US011（FN037, FN038, FN039, FN040）

-   [x] `Admin/AttendanceController@show` メソッドの実装（FN037: 詳細情報取得機能）
-   [x] `Admin/AttendanceController@update` メソッドの実装（FN040: 修正機能）
-   [x] `routes/web.php` に `/admin/attendance/{id}` ルート追加（GET）
-   [x] `routes/web.php` に `/admin/attendance/{id}` ルート追加（PUT: 修正処理）
-   [x] `resources/views/admin/attendance/detail.blade.php` の作成
    -   [x] 一般ユーザー用の`attendance/detail.blade.php`をベースに作成
    -   [x] ヘッダーメニューは共通レイアウトで自動的に管理者用に切り替わる
    -   [x] フォームの action を管理者用の修正ルートに設定
-   [x] FN037: 詳細情報取得機能の実装
    -   [x] 動線上で選択した情報と一致することを確認
    -   [x] 実際の勤怠内容が正しく反映されることを確認
-   [x] FN038: 項目編集機能の実装
    -   [x] 「出勤・退勤」「休憩」「備考」の 4 つの項目を編集可能にする
    -   [x] 承認待ちの申請詳細がある場合は修正不可にし、「承認待ちのため修正はできません。」とメッセージ表示
-   [x] FN039: バリデーション機能の実装（FormRequest 使用）
    -   [x] 出勤時間が退勤時間より後の場合のエラーメッセージ
    -   [x] 退勤時間が出勤時間より前の場合のエラーメッセージ
    -   [x] 休憩開始時間が出勤時間より前の場合のエラーメッセージ
    -   [x] 休憩開始時間が退勤時間より後の場合のエラーメッセージ
    -   [x] 休憩終了時間が退勤時間より後の場合のエラーメッセージ
    -   [x] 備考欄が未入力の場合のエラーメッセージ
-   [x] FN040: 修正機能の実装
    -   [x] 「修正」ボタン押下で管理者として直接修正を実行
    -   [x] 修正された内容が一般ユーザーの勤怠情報にも反映されることを確認

### 12. スタッフ一覧画面（PG10）

### US012: 管理者ユーザーはスタッフ一覧を確認することができる

| 要件 ID | 機能一覧             | 機能詳細（完了状態）                                                   |
| ------- | -------------------- | ---------------------------------------------------------------------- |
| FN041   | ユーザー情報取得機能 | 全一般ユーザーの「氏名」「メールアドレス」が正しく表示されていること   |
| FN042   | 月次勤怠遷移機能     | 「詳細」を押下することによって，各ユーザーの月次勤怠一覧に遷移すること |

-   [ ] `Admin/StaffController` の作成
-   [ ] `routes/web.php` に `/admin/staff/list` ルート追加
-   [ ] `resources/views/admin/staff/list.blade.php` の作成
-   [ ] スタッフ一覧表示機能の実装

### 13. スタッフ別勤怠一覧画面（PG11）

-   [ ] `Admin/AttendanceController@staff` メソッドの追加
-   [ ] `routes/web.php` に `/admin/attendance/staff/{id}` ルート追加
-   [ ] `resources/views/admin/attendance/staff.blade.php` の作成
-   [ ] スタッフ別勤怠一覧表示機能の実装
-   [ ] 月次表示機能の実装

### 14. 申請一覧画面（管理者）（PG12）

-   [ ] `Admin/StampCorrectionRequestController` の作成（または既存コントローラーの拡張）
-   [ ] `resources/views/admin/stamp_correction_request/list.blade.php` の作成
-   [ ] 管理者向け申請一覧表示機能の実装

### 15. 修正申請承認画面（PG13）

-   [ ] `Admin/StampCorrectionRequestController@approve` メソッドの追加
-   [ ] `routes/web.php` に `/stamp_correction_request/approve/{id}` ルート追加
-   [ ] `resources/views/admin/stamp_correction_request/approve.blade.php` の作成
-   [ ] 承認処理の実装
-   [ ] 勤怠情報更新処理の実装

---

## 実装時の注意点

### 依存関係

#### データベースの依存関係

-   **`roles` テーブル**は最初に作成する必要がある（他のテーブルに依存しない）
-   **`users` テーブル**は `roles` テーブルに依存するため、`roles` の後に作成
-   **`attendances` テーブル**は `users` テーブルに依存するため、`users` の後に作成
-   **`break_times` テーブル**は `attendances` テーブルに依存するため、`attendances` の後に作成
-   **`stamp_correction_requests` テーブル**は `attendances` テーブルに依存するため、`attendances` の後に作成
-   **`break_corrections` テーブル**は `stamp_correction_requests` テーブルに依存するため、`stamp_correction_requests` の後に作成

#### シーダーの実行順序

-   **`RoleSeeder`**は最初に実行する必要がある（`users` テーブルの `role_id` が `roles` テーブルを参照するため）
-   **管理者ユーザーの作成**は `RoleSeeder` の後に実行する（`role_id` を取得するため）

#### 機能の依存関係

-   **認証機能**は他の機能の前提となるため、最初に実装する
-   **勤怠登録機能**は勤怠一覧・詳細の前提となるため、先に実装する
-   **管理者機能**は一般ユーザー機能の実装後に進めることを推奨

### 認証機能の実装について

**重要**: 一般ユーザーと管理者ユーザーの両方で、認証機能には **Fortify** を使用します。

-   **一般ユーザー認証**（FN001, FN006）: Fortify を使用
-   **管理者ユーザー認証**（FN014）: Fortify を使用

Fortify は Laravel の認証パッケージで、以下の機能を提供します：

-   ログイン・ログアウト処理
-   会員登録処理
-   パスワードリセット機能（必要に応じて）
-   認証ミドルウェアとの連携

管理者ログイン画面（PG07）の実装では、Fortify の認証メソッド（`Auth::attempt()` など）を使用して、管理者ロール（`Role::NAME_ADMIN`）を持つユーザーのみを認証するように実装します。

### 各画面実装時の手順

1. コントローラーの作成
2. ルーティングの追加
3. ビューファイルの作成
4. バリデーションの実装
5. ビジネスロジックの実装
6. エラーハンドリングの実装

### テスト推奨順序

1. 単体テスト（コントローラー、モデル）
2. 統合テスト（ルーティング、認証）
3. 画面テスト（ビュー、フォーム）

---

## 応用要件（後回し）

以下の機能は基本機能の実装完了後に実装します：

-   **FN011**: メール認証機能
-   **FN012**: 認証メール再送機能
-   **FN045**: CSV 出力機能

応用要件の実装は、「応用要件を進める」という合図を待ってから開始してください。
