# roles テーブルの name と label の設計理由

## 概要

`roles`テーブルの`name`カラムを UNIQUE キーにした理由と、`label`カラムの意味・役割について説明します。

---

## 1. `name`を UNIQUE キーにした理由

### 理由 1: ロール名で検索している

コード内で`name`を使ってロールを検索しています：

```php
// CreateNewUser.php
$userRole = Role::where('name', Role::NAME_USER)->firstOrFail();

// FortifyServiceProvider.php
$userRole = Role::where('name', Role::NAME_USER)->first();
```

**UNIQUE 制約がない場合の問題**:

-   同じ`name`（例: 'user'）が複数存在する可能性がある
-   `firstOrFail()`で複数のレコードが返される可能性がある
-   どのロールを使うべきか判断できない

**UNIQUE 制約がある場合のメリット**:

-   `name`で検索すると、必ず 1 つのレコードが返される
-   データの整合性が保たれる
-   アプリケーションのロジックが正しく動作する

---

### 理由 2: ロール名が識別子として機能している

```php
// Role.php
public const NAME_USER = 'user';
public const NAME_ADMIN = 'admin';

public function isAdmin(): bool
{
    return $this->name === self::NAME_ADMIN;  // nameで判定
}

public function isUser(): bool
{
    return $this->name === self::NAME_USER;  // nameで判定
}
```

`name`（'user', 'admin'）は識別子として使われているため、一意である必要があります。

**UNIQUE 制約がない場合の問題**:

-   同じ`name`が複数存在すると、判定ロジックが正しく動作しない
-   データの整合性が保証できない

---

### 理由 3: データ整合性の保証

**初期データ**:

```php
// マイグレーション
DB::table('roles')->insert([
    ['name' => 'user', 'label' => '一般ユーザー'],
    ['name' => 'admin', 'label' => '管理者'],
]);
```

初期データで`'user'`と`'admin'`が 1 つずつ存在することを前提としています。

**UNIQUE 制約がある場合のメリット**:

-   誤って同じ`name`のレコードが作成されることを防げる
-   データの整合性が自動的に保証される

---

### 理由 4: ユーザー登録時のロール取得

```php
// ユーザー登録時
$userRole = Role::where('name', Role::NAME_USER)->firstOrFail();
// → 'user'というnameを持つロールを1つ取得する必要がある
```

**UNIQUE 制約がない場合の問題**:

-   複数の'user'ロールが存在すると、どれを使うべきか判断できない
-   アプリケーションの動作が不安定になる

---

## 2. `label`カラムの意味と役割

### `label`カラムの意味

`label`は「表示名」を保存するカラムです。

-   **`name`**: 識別子（'user', 'admin'）- コード内で使用
-   **`label`**: 表示名（'一般ユーザー', '管理者'）- 画面表示用

---

### `label`と`name`の役割分担

| 項目       | `name`                   | `label`                  |
| ---------- | ------------------------ | ------------------------ |
| **役割**   | 識別子（コード内で使用） | 表示名（画面表示用）     |
| **値の例** | 'user', 'admin'          | '一般ユーザー', '管理者' |
| **変更**   | 変更不可（コードに依存） | 変更可能（表示のみ）     |
| **検索**   | コード内で検索に使用     | 検索には使用しない       |
| **多言語** | 言語に依存しない         | 言語ごとに変更可能       |

---

### `label`が必要な理由

#### 理由 1: `name`だけでは表示に適さない

**`name`を表示に使う場合の問題**:

```php
// ❌ 問題がある例
echo $user->role->name;  // 'user' と表示される（分かりにくい）
```

**`label`を使う場合**:

```php
// ✅ 適切な例
echo $user->role->label;  // '一般ユーザー' と表示される（分かりやすい）
```

---

#### 理由 2: `name`を変更できない

`name`はコード内で検索に使われているため、変更できません：

```php
// コード内での使用
$userRole = Role::where('name', Role::NAME_USER)->firstOrFail();
// Role::NAME_USER = 'user' で検索している

// もしnameを'一般ユーザー'に変更すると
// → 検索できなくなる ❌
```

**`label`があれば**:

-   `name`は'user'のまま（コードは動く）
-   `label`だけ'一般ユーザー'→'スタッフ'に変更可能

---

#### 理由 3: 将来的な拡張性

**管理画面での表示**:

**`label`がある場合**:

```php
// 将来的に管理画面を作成した場合
@foreach($users as $user)
    <tr>
        <td>{{ $user->name }}</td>
        <td>{{ $user->role->label }}</td>  // ← labelがあれば簡単に表示できる
    </tr>
@endforeach
```

**`label`がない場合（テーブルカラムなし）**:

テーブルカラムに`label`を持たなくても、以下の方法で実現できます：

**代替案 1: モデル内でメソッドとして実装**

```php
// Role.php
public function getLabel(): string
{
    $labels = [
        self::NAME_USER => '一般ユーザー',
        self::NAME_ADMIN => '管理者',
    ];
    return $labels[$this->name] ?? $this->name;
}

// ビュー
<td>{{ $user->role->getLabel() }}</td>  // ← メソッドで取得
```

**代替案 2: Laravel の翻訳ファイル（lang）で管理**

```php
// resources/lang/ja/roles.php
return [
    'user' => '一般ユーザー',
    'admin' => '管理者',
];

// ビュー
<td>{{ __('roles.' . $user->role->name) }}</td>  // ← 翻訳ファイルから取得
```

**代替案 3: コード内で条件分岐**

```php
@foreach($users as $user)
    <tr>
        <td>{{ $user->name }}</td>
        <td>
            @if($user->role->name === 'user')
                一般ユーザー
            @elseif($user->role->name === 'admin')
                管理者
            @endif
        </td>  // ← コードが複雑になる、新しいロール追加時に修正が必要
    </tr>
@endforeach
```

**代替案 4: name をそのまま表示**

```php
<td>{{ $user->role->name }}</td>  // ← 'user' や 'admin' と表示される（分かりにくい）
```

**比較**:

| 項目               | `label`カラムあり | モデルメソッド  | 翻訳ファイル    | 条件分岐      |
| ------------------ | ----------------- | --------------- | --------------- | ------------- |
| **コードの簡潔性** | ✅ シンプル       | ✅ シンプル     | ✅ シンプル     | ❌ 複雑       |
| **保守性**         | ✅ DB 変更のみ    | ⚠️ コード修正   | ✅ ファイル修正 | ❌ コード修正 |
| **可読性**         | ✅ 分かりやすい   | ✅ 分かりやすい | ✅ 分かりやすい | ⚠️ 複雑       |
| **拡張性**         | ✅ 簡単           | ⚠️ コード修正   | ✅ 簡単         | ❌ コード修正 |
| **多言語対応**     | ⚠️ 設計変更必要   | ⚠️ 設計変更必要 | ✅ 標準機能     | ❌ 困難       |
| **データベース**   | ⚠️ カラム追加     | ✅ 不要         | ✅ 不要         | ✅ 不要       |

**コードの簡潔性の詳細比較**:

**`label`カラムがある場合**:

```php
// ビュー
<td>{{ $user->role->label }}</td>  // ← 1行で完結、最もシンプル
```

**モデルメソッドの場合**:

```php
// Role.php（モデルに追加が必要）
public function getLabel(): string
{
    $labels = [
        self::NAME_USER => '一般ユーザー',
        self::NAME_ADMIN => '管理者',
    ];
    return $labels[$this->name] ?? $this->name;
}

// ビュー
<td>{{ $user->role->getLabel() }}</td>  // ← メソッド呼び出しが必要
```

**翻訳ファイルの場合**:

```php
// resources/lang/ja/roles.php（ファイル作成が必要）
return [
    'user' => '一般ユーザー',
    'admin' => '管理者',
];

// ビュー
<td>{{ __('roles.' . $user->role->name) }}</td>  // ← 関数呼び出しが必要
```

**カラム vs モデルメソッドの比較**:

| 項目               | テーブルカラム                                | モデルメソッド                                         |
| ------------------ | --------------------------------------------- | ------------------------------------------------------ |
| **コードの簡潔性** | ✅ 最もシンプル（`$user->role->label`）       | ⚠️ メソッド呼び出しが必要（`$user->role->getLabel()`） |
| **実装の複雑さ**   | ✅ カラム追加のみ                             | ⚠️ メソッド実装が必要                                  |
| **保守性**         | ✅ DB の値を変更するだけ                      | ❌ コード修正が必要                                    |
| **拡張性**         | ✅ 新しいロール追加が簡単（DB に追加）        | ❌ コード修正が必要                                    |
| **データベース**   | ⚠️ カラムが増える                             | ✅ カラム不要                                          |
| **パフォーマンス** | ✅ データベースから取得（高速）               | ✅ メモリ内で計算（高速）                              |
| **多言語対応**     | ⚠️ 設計変更必要（`label_ja`, `label_en`など） | ⚠️ 設計変更必要                                        |

**推奨**:

### テーブルカラムを推奨する場合

-   表示名を頻繁に変更する可能性がある
-   管理画面などで表示名を編集したい
-   データベースから直接確認したい
-   コードを変更せずに表示名を変更したい

### モデルメソッドを推奨する場合

-   表示名が固定で変更しない
-   データベースのカラムを増やしたくない
-   コード内で完結させたい

### 結論

**テーブルカラム（`label`）を推奨します。**

**理由**:

1.  **コードが最もシンプル**: `$user->role->label`で完結
2.  **保守性が高い**: データベースの値を変更するだけで対応可能
3.  **拡張性が高い**: 新しいロール追加時にコード修正が不要
4.  **実装が簡単**: カラム追加のみで実現可能

ただし、表示名が固定で変更しない場合は、モデルメソッドでも問題ありません。

---

**結論**:

-   **コードの簡潔性**: `label`カラムが最もシンプル（`$user->role->label`で完結）
-   **実装の複雑さ**: モデルメソッドや翻訳ファイルは追加実装が必要
-   **保守性**: 翻訳ファイルが最も柔軟（多言語対応が標準機能）

テーブルカラムに`label`を持たなくても、モデルメソッドや翻訳ファイルで実現可能です。ただし、テーブルカラムに持つメリットもあります。

**多言語対応**:
将来的に多言語対応する場合、`label`を拡張できます：

```php
// 案1: カラムを分ける
label_ja: '一般ユーザー'
label_en: 'User'

// 案2: JSONカラム
label: {"ja": "一般ユーザー", "en": "User"}
```

---

### 現在の使用状況

**現在**: `label`カラムは使用されていません

-   コード内で`$role->label`を参照している箇所はない
-   画面でロール名を表示する処理がない

**将来**: 以下の用途で使用される可能性があります

-   管理画面でのロール表示
-   ユーザー一覧でのロール表示
-   多言語対応

---

## まとめ

### `name`を UNIQUE キーにした理由

1. **ロール名で検索している**: `Role::where('name', Role::NAME_USER)`で検索するため、一意である必要がある
2. **識別子として機能**: `name`は識別子として使われており、一意である必要がある
3. **データ整合性の保証**: 同じ`name`が複数存在することを防ぐ
4. **アプリケーションの動作保証**: ユーザー登録時など、ロール取得時に 1 つのレコードが返されることを保証

### `label`カラムの意味

1. **表示名を保存**: 画面表示用の分かりやすい名前（'一般ユーザー', '管理者'）
2. **`name`との役割分担**: `name`は識別子、`label`は表示名
3. **変更可能**: `name`は変更できないが、`label`は変更可能
4. **将来的な拡張性**: 管理画面や多言語対応で使用される可能性がある

---

## 参考

-   **現在のテーブル設計**: `docs/仕様/現在のテーブル設計.md`
-   **ロール管理パターン比較**: `docs/仕様/ロール管理パターン比較.md`
