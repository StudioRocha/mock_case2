# 日付跨ぎ勤怠のユーザービリティ改善について

## 概要

日をまたぐ勤務（徹夜勤務）の場合、現在の実装では技術的には正しく動作していますが、ユーザービリティの観点で改善の余地があります。

---

## 現在の実装状況

### テストデータの作成

日をまたぐ勤務のテストデータを作成するには、以下のシーダーを実行します：

**Docker コンテナ内で実行:**

```bash
docker compose exec -u $(id -u):$(id -g) php php artisan db:seed --class=OvernightAttendanceSeeder
```

このシーダーは、今日の日付で 23:00 に出勤し、翌日の 02:00 に退勤する勤怠レコードを作成します。

**ファイル位置**: `database/seeders/OvernightAttendanceSeeder.php`

---

### データ構造

日をまたぐ勤務の場合、以下のようにデータが保存されます：

**例: 2025 年 11 月 25 日 23:00 に出勤 → 2025 年 11 月 26 日 02:00 に退勤**

-   `date`: `2025-11-25`（出勤した日の日付、退勤時には変更されない）
-   `clock_in_time`: `2025-11-25 23:00:00`（実際の出勤日時、`datetime`型）
-   `clock_out_time`: `2025-11-26 02:00:00`（実際の退勤日時、翌日、`datetime`型）

**重要なポイント**:

-   データベース上では、`clock_out_time`は`datetime`型のため、**日付情報は既に保存されている**
-   問題は**UI での表示方法**のみ
-   現在の実装では、退勤時刻を`format('H:i')`で表示しているため、日付部分が表示されていない

### 現在の表示

**勤怠一覧画面:**

-   日付: `11/25`（出勤日の日付）
-   出勤: `23:00`
-   退勤: `02:00` ← **日付が表示されないため、当日の 02:00 か翌日の 02:00 か分からない**

**勤怠詳細画面:**

-   同様に、退勤時刻に日付が表示されない

---

## 現在の問題点

### 1. 退勤時刻の日付が不明確（UI の問題）

**問題**: 退勤時刻が`02:00`と表示されるが、これが当日の 02:00 なのか翌日の 02:00 なのか分からない

**原因**:

-   データベースには日付情報が保存されている（`clock_out_time`が`datetime`型）
-   しかし、UI では`format('H:i')`で時刻のみを表示しているため、日付が表示されていない
-   **これはデータの問題ではなく、UI 表示の問題**

**例**:

-   通常の勤務: `09:00 ~ 18:00` → 問題なし
-   日付跨ぎ: `23:00 ~ 02:00` → 翌日の 02:00 なのか当日の 02:00 なのか不明確

### 2. 翌日の一覧に表示されない

**問題**: 11 月 26 日に退勤した場合でも、`date`カラムが`2025-11-25`のため、11 月 26 日の一覧には表示されない

**影響**:

-   ユーザーが「昨日働いたのに一覧にない」と混乱する可能性
-   11 月 26 日の一覧を見ても、前日からの継続勤務が分からない

### 3. 視覚的な識別が困難

**問題**: 日付跨ぎの勤務かどうかを一目で判断できない

---

## 改善案

### 案 1: 退勤時刻に日付を表示（推奨）

日付跨ぎの場合のみ、退勤時刻に日付を表示する。

**実装方針**:

-   退勤時刻の日付が`date`カラムの日付と異なる場合、日付も表示
-   通常の勤務（同日退勤）の場合は時刻のみ表示

**表示例**:

-   通常の勤務: `09:00 ~ 18:00`
-   日付跨ぎ: `23:00 ~ 11/26 02:00` ← 日付を表示

**実装箇所**:

1. 勤怠一覧画面（`resources/views/attendance/list.blade.php`）
2. 勤怠詳細画面（`resources/views/attendance/detail.blade.php`）

**実装コード例**:

```php
@if($attendance->clock_out_time)
    @php
        $clockOut = \Carbon\Carbon::parse($attendance->clock_out_time);
        $clockOutDate = $clockOut->format('Y-m-d');
        $attendanceDate = $attendance->date->format('Y-m-d');
        $isOvernight = $clockOutDate !== $attendanceDate;
    @endphp
    @if($isOvernight)
        {{ $clockOut->format('m/d H:i') }}
        {{-- 例: 11/26 02:00 --}}
    @else
        {{ $clockOut->format('H:i') }}
        {{-- 例: 18:00 --}}
    @endif
@endif
```

**メリット**:

-   実装が簡単
-   日付跨ぎが明確になる
-   通常の勤務には影響しない（表示が変わらない）

**デメリット**:

-   翌日の一覧には表示されない（これは設計上の制約）

---

### 案 2: 視覚的なインジケーター

日付跨ぎの勤務にアイコンやバッジを表示する。

**表示例**:

-   `23:00 ~ 02:00 [日跨ぎ]`
-   `23:00 ~ 02:00 🌙`

**メリット**:

-   一目で日付跨ぎと分かる

**デメリット**:

-   退勤時刻の日付は依然として不明確

---

### 案 3: 翌日の一覧にも参考表示（実装が複雑）

11 月 26 日の一覧に「前日からの継続勤務」として表示する。

**実装方針**:

-   11 月 26 日の一覧を表示する際、`clock_out_time`が 11 月 26 日を含むレコードも検索
-   参考情報として表示（編集不可）

**メリット**:

-   翌日の一覧にも表示される

**デメリット**:

-   実装が複雑（クエリが複雑になる）
-   データの整合性管理が難しい
-   優先度は低い

---

## 推奨する改善

**案 1（退勤時刻に日付を表示）を推奨します。**

**理由**:

1. 実装が簡単で、既存のコードへの影響が少ない
2. 日付跨ぎの勤務が明確になる
3. 通常の勤務には影響しない（表示が変わらない）
4. ユーザーの混乱を最小限に抑えられる

---

## 実装時の注意点

### 1. コントローラーでの判定

ビューで判定するのではなく、コントローラーで判定してビューに渡す方が良い場合もあります。

```php
// AttendanceController.php
$isOvernight = false;
$clockOutDisplay = '';

if ($attendance->clock_out_time) {
    $clockOut = Carbon::parse($attendance->clock_out_time);
    $clockOutDate = $clockOut->format('Y-m-d');
    $attendanceDate = $attendance->date->format('Y-m-d');
    $isOvernight = $clockOutDate !== $attendanceDate;

    $clockOutDisplay = $isOvernight
        ? $clockOut->format('m/d H:i')
        : $clockOut->format('H:i');
}
```

### 2. 修正申請時の表示

承認待ちの修正申請がある場合、`requested_clock_out_time`も同様に判定する必要があります。

```php
// 承認待ちの場合
$displayClockOutTime = $hasPendingRequest && $pendingRequest->requested_clock_out_time
    ? Carbon::parse($pendingRequest->requested_clock_out_time)->format('H:i')
    : ($attendance->clock_out_time ? Carbon::parse($attendance->clock_out_time)->format('H:i') : '');

// 日付跨ぎ判定も必要
```

---

## まとめ

### データベース側の状況

-   **データベースには日付情報が既に保存されている**
    -   `clock_out_time`は`datetime`型のため、日付と時刻の両方が保存されている
    -   例: `2025-11-26 02:00:00`（日付情報も含まれている）

### UI 側の問題

-   **問題は UI での表示方法のみ**
    -   現在は`format('H:i')`で時刻のみを表示
    -   日付跨ぎの場合、日付も表示することで問題を解決できる

### 改善の方向性

現在の実装は技術的には正しく動作していますが、ユーザービリティの観点で改善の余地があります。

**改善は UI 表示の変更のみで対応可能**（データベースの変更は不要）

**推奨する改善**:

-   退勤時刻が日付跨ぎの場合、日付も表示する（案 1）

**実装優先度**:

-   高: 案 1（退勤時刻に日付を表示）
-   中: 案 2（視覚的なインジケーター）
-   低: 案 3（翌日の一覧にも表示）

**実装時期**:

-   基本機能の実装が完了した後、ユーザービリティ改善として実装することを推奨
