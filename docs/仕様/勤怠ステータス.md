# 勤怠ステータスについて

## 概要

勤怠管理アプリにおける勤怠ステータスの定義、使用タイミング、遷移フローをまとめたドキュメントです。

---

## ステータス定義

`Attendance`モデルで定義されている4つのステータス定数：

| 定数名 | 値 | ラベル | 説明 |
|--------|-----|--------|------|
| `STATUS_OFF_DUTY` | 0 | 勤務外 | まだ出勤していない状態 |
| `STATUS_WORKING` | 1 | 出勤中 | 出勤ボタンを押した後、休憩中でも退勤済みでもない状態 |
| `STATUS_BREAK` | 2 | 休憩中 | 休憩ボタンを押した状態 |
| `STATUS_FINISHED` | 3 | 退勤済 | 退勤ボタンを押した後の状態 |

**定義場所**: `src/app/Models/Attendance.php`

```php
public const STATUS_OFF_DUTY = 0;
public const STATUS_WORKING = 1;
public const STATUS_BREAK = 2;
public const STATUS_FINISHED = 3;
```

---

## 各ステータスの詳細

### 1. STATUS_OFF_DUTY (0) - 勤務外

**意味**: まだ出勤していない状態

**使用タイミング**:
- 今日の勤怠レコードが存在しない場合
- かつ、前日の未退勤レコードも存在しない場合

**データベースへの保存**: **保存されない**（仮想的なステータス）

**画面表示**:
- 「勤務外」と表示される
- 「出勤」ボタンが表示される

**実装箇所**:
- `AttendanceController@index()`: レコードが見つからない場合に設定
- `resources/views/attendance/index.blade.php`: 出勤ボタン表示の条件

---

### 2. STATUS_WORKING (1) - 出勤中

**意味**: 出勤ボタンを押した後、休憩中でも退勤済みでもない状態

**使用タイミング**:
- 出勤ボタンを押した時
- 休憩終了ボタンを押した時

**データベースへの保存**: **保存される**（`attendances.status`カラム）

**画面表示**:
- 「出勤中」と表示される
- 「退勤」ボタンと「休憩入」ボタンが表示される

**実装箇所**:
- `AttendanceController@clockIn()`: 出勤時に`STATUS_WORKING`を設定
- `AttendanceController@breakEnd()`: 休憩終了時に`STATUS_WORKING`に戻す

---

### 3. STATUS_BREAK (2) - 休憩中

**意味**: 休憩ボタンを押した状態

**使用タイミング**:
- 休憩開始ボタンを押した時

**データベースへの保存**: **保存される**（`attendances.status`カラム）

**画面表示**:
- 「休憩中」と表示される
- 「休憩戻」ボタンが表示される

**実装箇所**:
- `AttendanceController@breakStart()`: 休憩開始時に`STATUS_BREAK`を設定

---

### 4. STATUS_FINISHED (3) - 退勤済

**意味**: 退勤ボタンを押した後の状態

**使用タイミング**:
- 退勤ボタンを押した時

**データベースへの保存**: **保存される**（`attendances.status`カラム）

**画面表示**:
- 「退勤済」と表示される
- 「お疲れ様でした。」というメッセージが表示される
- ボタンは表示されない

**実装箇所**:
- `AttendanceController@clockOut()`: 退勤時に`STATUS_FINISHED`を設定

---

## ステータス遷移フロー

```
[STATUS_OFF_DUTY]
    ↓ 出勤ボタン
[STATUS_WORKING]
    ↓ 休憩開始ボタン
[STATUS_BREAK]
    ↓ 休憩終了ボタン
[STATUS_WORKING]
    ↓ 退勤ボタン
[STATUS_FINISHED]
```

**注意**: `STATUS_FINISHED`から他のステータスへの遷移はありません（その日の勤務は終了）。

---

## 日付跨ぎの動作

### 通常の日付跨ぎ（徹夜勤務）

**例**: 1月15日 23:00に出勤 → 1月16日 02:00に退勤

1. **1月15日 23:00** - 出勤
   - `date` = 2024-01-15
   - `clock_in_time` = 2024-01-15 23:00:00
   - `status` = `STATUS_WORKING` (1)

2. **1月16日 00:04** - 画面アクセス
   - 今日（2024-01-16）のレコードは存在しない
   - 前日（2024-01-15）の未退勤レコードが見つかる
   - 「出勤中」と表示される（`STATUS_WORKING`）

3. **1月16日 02:00** - 退勤
   - 前日のレコードに対して退勤処理を実行
   - `clock_out_time` = 2024-01-16 02:00:00
   - `status` = `STATUS_FINISHED` (3)

### 退勤済み後の日付跨ぎ

**例**: 1月15日に退勤 → 1月16日にアクセス

1. **1月15日** - 退勤済み
   - `date` = 2024-01-15
   - `clock_out_time` = 2024-01-15 18:00:00（NULLではない）
   - `status` = `STATUS_FINISHED` (3)

2. **1月16日** - 画面アクセス
   - 今日（2024-01-16）のレコードは存在しない
   - 前日のレコードを探すが、`clock_out_time`がNULLでないため見つからない
   - **結果**: `STATUS_OFF_DUTY` (0) として表示される
   - 「出勤」ボタンが表示される

**重要なポイント**:
- `STATUS_FINISHED`がついてから日付をまたぐと、自動的に`STATUS_OFF_DUTY`として扱われる
- データベースの`status`カラムは`STATUS_FINISHED`のまま（変更されない）
- 画面表示上のみ`STATUS_OFF_DUTY`として扱われる

---

## 実装の詳細

### ステータス判定ロジック（`AttendanceController@index()`）

```php
// 今日の勤怠レコードを取得
$attendance = Attendance::where('user_id', Auth::id())
    ->where('date', $today)
    ->first();

// 今日のレコードが存在しない場合、前日のレコードでまだ退勤していないものを探す（日付跨ぎ対応）
if (!$attendance) {
    $yesterday = Carbon::yesterday()->format('Y-m-d');
    $attendance = Attendance::where('user_id', Auth::id())
        ->where('date', $yesterday)
        ->whereNotNull('clock_in_time')
        ->whereNull('clock_out_time')  // ← 未退勤のレコードのみ
        ->first();
}

// ステータスを判定
if (!$attendance) {
    $status = Attendance::STATUS_OFF_DUTY;  // ← レコードが見つからない場合
} else {
    $status = $attendance->status;  // ← データベースのstatusカラムの値を使用
}
```

### 画面表示ロジック（`attendance/index.blade.php`）

```blade
@if($status === \App\Models\Attendance::STATUS_OFF_DUTY)
    {{-- 出勤ボタン --}}
@elseif($status === \App\Models\Attendance::STATUS_WORKING)
    {{-- 退勤ボタン + 休憩入ボタン --}}
@elseif($status === \App\Models\Attendance::STATUS_BREAK)
    {{-- 休憩戻ボタン --}}
@elseif($status === \App\Models\Attendance::STATUS_FINISHED)
    {{-- お疲れ様でした。メッセージ --}}
@endif
```

---

## データベースへの保存

| ステータス | データベースに保存されるか | 保存される値 |
|-----------|------------------------|------------|
| `STATUS_OFF_DUTY` | ❌ 保存されない | - |
| `STATUS_WORKING` | ✅ 保存される | `1` |
| `STATUS_BREAK` | ✅ 保存される | `2` |
| `STATUS_FINISHED` | ✅ 保存される | `3` |

**注意**: `STATUS_OFF_DUTY`はデータベースに保存されません。レコードが存在しない状態を表す仮想的なステータスです。

---

## 関連ファイル

- **モデル定義**: `src/app/Models/Attendance.php`
- **コントローラー**: `src/app/Http/Controllers/AttendanceController.php`
- **ビューファイル**: `src/resources/views/attendance/index.blade.php`
- **テーブル設計**: `docs/仕様/テーブル設計案.md`

---

## 参考

- **機能要件**: `docs/仕様/機能要件一覧.md` (FN020, FN021, FN022)
- **テーブル設計**: `docs/仕様/テーブル設計案.md` (statusカラムの説明)

