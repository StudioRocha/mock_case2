# ユーザーロール仕様

## 概要

本アプリケーションでは、ユーザーをロール（役割）によって分類し、アクセス権限を制御します。

---

## ロール定義

### ロールの種類

| ロール         | 値  | 説明                                                 |
| -------------- | --- | ---------------------------------------------------- |
| 一般ユーザー   | `0` | 勤怠の打刻、勤怠一覧の確認、修正申請などが可能       |
| 管理者ユーザー | `1` | 全ユーザーの勤怠情報の確認、修正申請の承認などが可能 |

### 定数定義

**実装ファイル**: `app/Models/User.php`

```php
public const ROLE_USER = 0;   // 一般ユーザー
public const ROLE_ADMIN = 1;  // 管理者ユーザー
```

---

## データベース構造

### users テーブル

**カラム名**: `role`  
**データ型**: `integer`  
**NOT NULL**: はい  
**デフォルト値**: なし

**マイグレーションファイル**: `database/migrations/2014_10_12_000000_create_users_table.php`

```php
$table->integer('role');
```

---

## 現在の実装状況

### 1. 会員登録時

**実装ファイル**: `app/Actions/Fortify/CreateNewUser.php`

-   新規会員登録時、自動的に`ROLE_USER`（0）が設定される
-   一般ユーザーとして登録される

```php
return User::create([
    'name' => $input['name'],
    'email' => $input['email'],
    'password' => Hash::make($input['password']),
    'role' => User::ROLE_USER,  // 自動的に一般ユーザーに設定
]);
```

### 2. ログイン時（一般ユーザー）

**実装ファイル**: `app/Providers/FortifyServiceProvider.php`

-   一般ユーザー（`ROLE_USER = 0`）のみログイン可能
-   管理者ユーザー（`ROLE_ADMIN = 1`）は現在ログインできない

```php
$user = User::where('email', $request->email)
    ->where('role', User::ROLE_USER)  // 一般ユーザーのみ
    ->first();
```

### 3. 認証ミドルウェア

**実装ファイル**: `routes/web.php`

-   一般ユーザー向けのルートは`auth`ミドルウェアで保護
-   現在、管理者向けのルートは未実装（コメントアウト）

```php
Route::middleware(['auth'])->group(function () {
    // 一般ユーザー向けのルート
});
```

---

## 今後の実装予定（管理者機能）

### 1. 管理者ユーザーの作成

**実装方法（想定）**:

-   シーダーまたは管理画面で管理者ユーザーを作成
-   `role`を`User::ROLE_ADMIN`（1）に設定

**実装例**:

```php
User::create([
    'name' => '管理者',
    'email' => 'admin@example.com',
    'password' => Hash::make('password'),
    'role' => User::ROLE_ADMIN,  // 管理者として設定
]);
```

### 2. 管理者ログイン機能

**実装方法（想定）**:

-   管理者専用のログイン画面を作成
-   `FortifyServiceProvider`または専用の認証処理で、`ROLE_ADMIN`のユーザーのみログイン可能にする

**実装例**:

```php
$user = User::where('email', $request->email)
    ->where('role', User::ROLE_ADMIN)  // 管理者のみ
    ->first();
```

### 3. 管理者向けルート保護

**実装方法（想定）**:

-   カスタムミドルウェア（例：`admin`）を作成
-   管理者向けのルートに`auth`と`admin`ミドルウェアを適用

**実装例**:

```php
Route::prefix('admin')->middleware(['auth', 'admin'])->group(function () {
    // 管理者向けのルート
});
```

### 4. 管理者向け機能

**機能要件一覧（US004 ～ US015）より**:

-   **US004**: 管理者ユーザーは、システムの管理機能にログインすることができる
-   **US005**: 管理者ユーザーは、管理機能からログアウトすることができる
-   **US010**: 管理者ユーザーは日次勤怠一覧を確認することができる
-   **US011**: 管理者ユーザーは各勤怠の詳細を確認・修正することができる
-   **US012**: 管理者ユーザーはスタッフ一覧を確認することができる
-   **US013**: 管理者ユーザーはスタッフ毎の月次勤怠一覧を確認することができる
-   **US014**: 管理者ユーザーは修正申請一覧を確認することができる
-   **US015**: 管理者ユーザーは修正申請の詳細を確認 / 承認することができる

---

## ロール判定の実装方法

### 現在の実装

```php
// Userモデルで定数を使用
if ($user->role === User::ROLE_USER) {
    // 一般ユーザーの処理
}

if ($user->role === User::ROLE_ADMIN) {
    // 管理者の処理
}
```

### 今後の実装（想定）

**ヘルパーメソッドの追加（推奨）**:

```php
// app/Models/User.php に追加
public function isAdmin(): bool
{
    return $this->role === self::ROLE_ADMIN;
}

public function isUser(): bool
{
    return $this->role === self::ROLE_USER;
}
```

**使用例**:

```php
if (Auth::user()->isAdmin()) {
    // 管理者の処理
}
```

---

## セキュリティ考慮事項

### 1. ロールの変更制限

-   一般ユーザーは自身のロールを変更できない
-   管理者ユーザーのみ、他のユーザーのロールを変更可能（実装予定）

### 2. ルート保護

-   管理者向けのルートは必ず`auth`と`admin`ミドルウェアで保護する
-   一般ユーザーが管理者機能にアクセスできないようにする

### 3. ビューの制御

-   管理者専用の UI 要素は、ロール判定で表示/非表示を制御する

**実装例**:

```blade
@if(Auth::user()->isAdmin())
    <a href="{{ route('admin.dashboard') }}">管理画面</a>
@endif
```

---

## 実装ファイル一覧

| ファイル                                                       | 説明                   |
| -------------------------------------------------------------- | ---------------------- |
| `app/Models/User.php`                                          | ロール定数の定義       |
| `app/Actions/Fortify/CreateNewUser.php`                        | 会員登録時のロール設定 |
| `app/Providers/FortifyServiceProvider.php`                     | ログイン時のロール判定 |
| `database/migrations/2014_10_12_000000_create_users_table.php` | データベース構造定義   |

---

## 関連仕様

-   **機能要件一覧**: US001（一般ユーザー会員登録）、US002（一般ユーザーログイン）、US004（管理者ログイン）
-   **テーブル設計案**: users テーブルの設計
-   **画面定義**: 一般ユーザー向け画面、管理者向け画面

---

## 注意事項

1. **ロールの値は変更しない**: 既存データとの整合性を保つため、定数の値（0, 1）は変更しないこと
2. **新しいロールの追加**: 将来的にロールを追加する場合は、新しい値（2, 3...）を使用し、既存の値は変更しない
3. **データベースの整合性**: `role`カラムは`NOT NULL`のため、必ず値が設定されている必要がある
