# テーブル設計案

## 概要

勤怠管理アプリに必要なテーブル設計（全 5 テーブル）

---

## 1. users テーブル（Laravel 標準テーブルを改造）

| No. | テーブル名 | カラム名          | 型           | PRIMARY KEY | UNIQUE KEY | NOT NULL | FOREIGN KEY |
| --- | ---------- | ----------------- | ------------ | ----------- | ---------- | -------- | ----------- |
| 1   | users      | id                | unsigned int | ○           |            | ○        |             |
|     |            | name              | varchar(255) |             |            | ○        |             |
|     |            | email             | varchar(255) |             | ○          | ○        |             |
|     |            | email_verified_at | timestamp    |             |            |          |             |
|     |            | password          | varchar(255) |             |            | ○        |             |
|     |            | role              | integer      |             |            | ○        |             |
|     |            | remember_token    | varchar(100) |             |            |          |             |
|     |            | created_at        | timestamp    |             |            |          |             |
|     |            | updated_at        | timestamp    |             |            |          |             |

**備考**:

-   Laravel 標準の`users`テーブルに`role`カラムを追加（`integer`型）
    -   `0`: 一般ユーザー（`User::ROLE_USER`）
    -   `1`: 管理者（`User::ROLE_ADMIN`）
-   管理者と一般ユーザーを区別

**リレーション**:

-   `attendances`テーブルと 1 対多の関係
    -   1 人のユーザーに対して複数の勤怠レコードが存在可能
-   `stamp_correction_requests`テーブルと 1 対多の関係（申請者として）
    -   1 人のユーザーに対して複数の修正申請レコードが存在可能
-   `stamp_correction_requests`テーブルと 1 対多の関係（承認者として）
    -   1 人の管理者が複数の修正申請を承認可能

---

## 2. attendances テーブル

| No. | テーブル名  | カラム名       | 型           | PRIMARY KEY | UNIQUE KEY | NOT NULL | FOREIGN KEY |
| --- | ----------- | -------------- | ------------ | ----------- | ---------- | -------- | ----------- |
| 2   | attendances | id             | unsigned int | ○           |            | ○        |             |
|     |             | user_id        | unsigned int |             |            | ○        | users(id)   |
|     |             | date           | date         |             |            | ○        |             |
|     |             | clock_in_time  | datetime     |             |            |          |             |
|     |             | clock_out_time | datetime     |             |            |          |             |
|     |             | status         | integer      |             |            | ○        |             |
|     |             | note           | varchar(500) |             |            |          |             |
|     |             | created_at     | timestamp    |             |            |          |             |
|     |             | updated_at     | timestamp    |             |            |          |             |

**備考**:

-   **`status`カラム**: その日の勤怠状態を表すステータス（`integer`型）
    -   `0`: 勤務外（`Attendance::STATUS_OFF_DUTY`）- まだ出勤していない状態（FN019, FN020）
    -   `1`: 出勤中（`Attendance::STATUS_WORKING`）- 出勤ボタンを押した後、休憩中でも退勤済みでもない状態（FN020, FN021, FN022）
    -   `2`: 休憩中（`Attendance::STATUS_BREAK`）- 休憩ボタンを押した状態（FN021）
    -   `3`: 退勤済（`Attendance::STATUS_FINISHED`）- 退勤ボタンを押した後の状態（FN022）
    -   このステータスに基づいて、UI に表示するボタンが変わる（FN020, FN021, FN022）
-   `user_id`と`date`の組み合わせでユニーク制約を実装済み（1 日 1 レコード）
-   **`clock_in_time`カラム**: 出勤日時（`datetime`型）
    -   徹夜・日付跨ぎの勤怠に対応するため、日付と時刻の両方を保存
    -   `date`カラムと組み合わせて使用（`date`は勤怠日、`clock_in_time`は実際の出勤日時）
-   **`clock_out_time`カラム**: 退勤日時（`datetime`型）
    -   徹夜・日付跨ぎの勤怠に対応するため、日付と時刻の両方を保存
    -   退勤が翌日になる場合も正しく記録可能
-   **`note`カラム**: 備考欄（`varchar(500)`, NULL 許可）
    -   出勤時点では NULL のまま（空文字列を設定しない）
    -   修正申請時にバリデーション: 未入力の場合は「備考を記入してください」というエラーメッセージを表示（FN029）

**リレーション**:

-   `users`テーブルと多対 1 の関係
    -   複数の勤怠レコードが 1 人のユーザーに紐づく
-   `break_times`テーブルと 1 対多の関係
    -   1 つの勤怠レコードに対して複数の休憩レコードが存在可能
-   `stamp_correction_requests`テーブルと 1 対多の関係
    -   1 つの勤怠レコードに対して複数の修正申請レコードが存在可能

---

## 3. break_times テーブル

| No. | テーブル名  | カラム名         | 型           | PRIMARY KEY | UNIQUE KEY | NOT NULL | FOREIGN KEY     |
| --- | ----------- | ---------------- | ------------ | ----------- | ---------- | -------- | --------------- |
| 3   | break_times | id               | unsigned int | ○           |            | ○        |                 |
|     |             | attendance_id    | unsigned int |             |            | ○        | attendances(id) |
|     |             | break_start_time | datetime     |             |            |          |                 |
|     |             | break_end_time   | datetime     |             |            |          |                 |
|     |             | created_at       | timestamp    |             |            |          |                 |
|     |             | updated_at       | timestamp    |             |            |          |                 |

**備考**:

-   1 つの勤怠（attendance）に対して複数の休憩レコードが存在可能
-   休憩開始・終了日時を記録（`datetime`型）
-   徹夜・日付跨ぎの勤怠に対応するため、日付と時刻の両方を保存

**リレーション**:

-   `attendances`テーブルと多対 1 の関係
    -   複数の休憩レコードが 1 つの勤怠レコードに紐づく

**`DATETIME`型について**:

-   **型名**: `DATETIME`
-   **説明**: 日付と時刻を保存するデータ型
-   **範囲**: `1000-01-01 00:00:00` から `9999-12-31 23:59:59` まで
-   **表示形式**: `YYYY-MM-DD HH:MM:SS`（例: `2024-01-15 12:00:00`）
-   **使用例**:
    -   `break_start_time`: `2024-01-15 12:00:00`（2024 年 1 月 15 日 12 時 00 分 00 秒）
    -   `break_end_time`: `2024-01-15 13:00:00`（2024 年 1 月 15 日 13 時 00 分 00 秒）
-   **`TIME`や`TIMESTAMP`との違い**:
    -   `TIME`: 時刻のみ（`12:00:00`）
    -   `DATETIME`: 日付と時刻（`2024-01-15 12:00:00`）
    -   `TIMESTAMP`: 日付と時刻（`2024-01-15 12:00:00`）+ タイムゾーン情報
-   **このテーブルで`DATETIME`を使う理由**:
    -   徹夜・日付跨ぎの勤怠に対応するため、日付と時刻の両方を保存
    -   休憩が翌日に跨る場合も正しく記録可能
    -   `date`カラム（勤怠日）と組み合わせて使用することで、日付跨ぎを自然に扱える

**データ例: 3 回休憩を取った場合**

1 つの`attendance`レコード（例: `id = 1`）に対して、`break_times`テーブルに**3 つのレコード**が作成されます：

| id  | attendance_id | break_start_time | break_end_time | created_at | updated_at |
| --- | ------------- | ---------------- | -------------- | ---------- | ---------- |
| 1   | 1             | 12:00:00         | 13:00:00       | 2024-01-15 | 2024-01-15 |
| 2   | 1             | 15:00:00         | 15:15:00       | 2024-01-15 | 2024-01-15 |
| 3   | 1             | 17:00:00         | 17:10:00       | 2024-01-15 | 2024-01-15 |

**ポイント**:

-   1 回の休憩 = 1 レコード
-   3 回の休憩 = 3 レコード
-   すべて同じ`attendance_id`（例: `1`）を持つ
-   各レコードが独立した休憩情報を保持

---

## 4. stamp_correction_requests テーブル

**日本語名**: 勤怠修正申請テーブル（または 打刻修正申請テーブル）

| No. | テーブル名                | カラム名                 | 型           | PRIMARY KEY | UNIQUE KEY | NOT NULL | FOREIGN KEY     |
| --- | ------------------------- | ------------------------ | ------------ | ----------- | ---------- | -------- | --------------- |
| 4   | stamp_correction_requests | id                       | unsigned int | ○           |            | ○        |                 |
|     |                           | attendance_id            | unsigned int |             |            | ○        | attendances(id) |
|     |                           | requested_clock_in_time  | datetime     |             |            |          |                 |
|     |                           | requested_clock_out_time | datetime     |             |            |          |                 |
|     |                           | requested_note           | varchar(500) |             |            | ○        |                 |
|     |                           | status                   | integer      |             |            | ○        |                 |
|     |                           | approved_at              | timestamp    |             |            |          |                 |
|     |                           | created_at               | timestamp    |             |            |          |                 |
|     |                           | updated_at               | timestamp    |             |            |          |                 |

**備考**:

-   **テーブル名の意味**:
    -   `stamp`: 打刻（出勤・退勤の記録）
    -   `correction`: 修正
    -   `request`: 申請
    -   → 「打刻修正申請」= 勤怠の修正申請
-   **役割**: 一般ユーザーが行った勤怠修正申請を管理するテーブル（FN030, FN051）
-   **`requested_note`カラム**: 修正申請時の備考欄（`varchar(500)`, NOT NULL）（FN027, FN029）
    -   ユーザーが修正申請時に記入する備考情報を保存
    -   バリデーション: 未入力の場合は「備考を記入してください」というエラーメッセージを表示（FN029）
    -   承認後、この内容が`attendances.note`に反映される（FN051）
-   **`status`カラムが必要な理由**: 修正申請の承認ワークフローを管理するため（`integer`型）
    -   **`0`（承認待ち）**: ユーザーが修正申請を提出したが、まだ管理者が承認していない状態
        -   一般ユーザーの「申請一覧画面」の「承認待ち」セクションに表示される（FN031）
        -   管理者の「申請一覧画面」の「承認待ち」セクションに表示される（FN047）
        -   この状態の申請は修正できない（FN027, FN038）
    -   **`1`（承認済み）**: 管理者が承認した状態
        -   一般ユーザーの「申請一覧画面」の「承認済み」セクションに表示される（FN032）
        -   管理者の「申請一覧画面」の「承認済み」セクションに表示される（FN048）
        -   承認時に、修正申請の内容が実際の勤怠データ（`attendances`, `break_times`）に反映される（FN051）
    -   **なぜ必要か**:
        1.  申請の状態を明確に管理できる（承認待ち vs 承認済み）
        2.  画面表示のフィルタリングが容易（`WHERE status = 0`など）
        3.  承認済みの申請を再度承認できないように制御できる
        4.  承認待ちの申請は修正できないように制御できる（FN027, FN038）
-   **`approved_at`カラム**: 承認日時（`timestamp`型、NULL 許可）
    -   承認待ち: `approved_at = NULL`
    -   承認済み: `approved_at = 承認日時`
    -   承認済みの判定は`approved_at`が`NULL`でないことで可能
    -   仕様上、承認者名の表示要件がないため、承認者 ID は保存しない

**リレーション**:

-   `attendances`テーブルと多対 1 の関係
    -   複数の修正申請レコードが 1 つの勤怠レコードに紐づく
    -   **申請者（ユーザー）は`attendance.user_id`経由で取得**（正規化のため`user_id`カラムは削除）
-   `break_corrections`テーブルと 1 対多の関係
    -   1 つの修正申請レコードに対して複数の休憩修正レコードが存在可能

---

## 5. break_corrections テーブル

**日本語名**: 休憩修正テーブル（または 休憩修正申請テーブル）

| No. | テーブル名        | カラム名                    | 型           | PRIMARY KEY | UNIQUE KEY | NOT NULL | FOREIGN KEY                   |
| --- | ----------------- | --------------------------- | ------------ | ----------- | ---------- | -------- | ----------------------------- |
| 5   | break_corrections | id                          | unsigned int | ○           |            | ○        |                               |
|     |                   | stamp_correction_request_id | unsigned int |             |            | ○        | stamp_correction_requests(id) |
|     |                   | requested_break_start_time  | datetime     |             |            |          |                               |
|     |                   | requested_break_end_time    | datetime     |             |            |          |                               |
|     |                   | created_at                  | timestamp    |             |            |          |                               |
|     |                   | updated_at                  | timestamp    |             |            |          |                               |

**備考**:

-   **テーブル名の意味**:
    -   `break`: 休憩
    -   `correction`: 修正
    -   → 「休憩修正」= 修正申請に紐づく休憩情報
-   **目的**: 修正申請に紐づく休憩情報を保存するテーブル
-   **役割**: ユーザーが修正申請時に希望する休憩時間を一時的に保存
-   **リレーション**:
    -   `stamp_correction_requests`テーブルと 1 対多の関係
    -   1 つの修正申請に対して複数の休憩修正レコードが存在可能（休憩は 1 日に複数回あるため）
-   **データフロー**:
    1.  ユーザーが勤怠詳細画面で修正申請を行う際、休憩時間も修正可能（FN027）
    2.  修正申請時に、希望する休憩時間が`break_corrections`テーブルに保存される
    3.  管理者が承認すると、`break_corrections`の内容が`break_times`テーブルに反映される（FN051）
-   **バリデーション要件**（FN029）:
    -   休憩開始時間が出勤時間より前になっている場合、エラー
    -   休憩開始時間が退勤時間より後になっている場合、エラー
    -   休憩終了時間が退勤時間より後になっている場合、エラー
-   **UI 要件**（FN026）:
    -   勤怠詳細画面で、既存の休憩回数分のレコードと追加で 1 つ分の入力フィールドが表示される
    -   ユーザーは既存の休憩を修正したり、新しい休憩を追加できる

**データ例: 1 つの修正申請に対して 3 回の休憩時間を修正した場合**

1 つの`stamp_correction_request`レコード（例: `id = 1`）に対して、`break_corrections`テーブルに**3 つのレコード**が作成されます：

| id  | stamp_correction_request_id | requested_break_start_time | requested_break_end_time | created_at | updated_at |
| --- | --------------------------- | -------------------------- | ------------------------ | ---------- | ---------- |
| 1   | 1                           | 12:00:00                   | 13:00:00                 | 2024-01-15 | 2024-01-15 |
| 2   | 1                           | 15:00:00                   | 15:15:00                 | 2024-01-15 | 2024-01-15 |
| 3   | 1                           | 17:00:00                   | 17:10:00                 | 2024-01-15 | 2024-01-15 |

**ポイント**:

-   1 回の休憩修正 = 1 レコード
-   3 回の休憩修正 = 3 レコード
-   すべて同じ`stamp_correction_request_id`（例: `1`）を持つ
-   各レコードが独立した休憩修正情報を保持
-   管理者が承認すると、これらの 3 つのレコードが`break_times`テーブルに反映される

---

## 4 番と 5 番のテーブルを分ける理由

### なぜ`stamp_correction_requests`と`break_corrections`を分けるのか？

**1. 正規化の原則（第 1 正規形の違反を避ける）**

-   休憩は 1 日に**複数回**存在する可能性がある（FN021: 休憩は 1 日に何回でも押下できる）
-   もし 1 つのテーブルに統合すると、1 つの修正申請レコードに対して複数の休憩情報を保存する必要がある
-   これは正規化の原則に反し、データの重複や更新の複雑化を招く

**2. データ構造の明確化**

-   **出勤・退勤情報**: 1 日 1 回のみ（`requested_clock_in_time`, `requested_clock_out_time`）
-   **休憩情報**: 1 日に複数回（`requested_break_start_time`, `requested_break_end_time`）
-   性質が異なるデータを分離することで、データ構造が明確になる

**3. 拡張性と柔軟性**

-   休憩の追加・削除が容易
-   休憩回数が 0 回でも問題なく動作（`break_corrections`にレコードが存在しないだけ）
-   将来的に休憩情報に追加項目が必要になった場合も対応しやすい

**4. データ操作の簡素化**

-   休憩情報の取得: `break_corrections`テーブルを JOIN するだけ
-   休憩情報の更新: 該当する`break_corrections`レコードのみ更新
-   承認時の反映: `break_corrections`の全レコードを`break_times`テーブルに一括反映

**5. もし統合した場合の問題点**

```
stamp_correction_requests テーブル（統合案）
- id
- attendance_id
- requested_clock_in_time
- requested_clock_out_time
- requested_note
- break_1_start_time, break_1_end_time  ← 固定カラム
- break_2_start_time, break_2_end_time  ← 固定カラム
- break_3_start_time, break_3_end_time  ← 固定カラム
- ...（休憩回数が不明なため、カラム数を決められない）
```

-   休憩回数が不明なため、カラム数を事前に決められない
-   休憩回数が少ない場合、多くの NULL カラムが発生（無駄）
-   休憩回数が多い場合、カラム数が不足する可能性
-   データの追加・削除が複雑になる

**結論**: 正規化の原則に従い、1 対多の関係を適切に表現するため、2 つのテーブルに分離する設計が最適です。

---

## テーブル間の関係

```
users (1) ──< (N) attendances
attendances (1) ──< (N) break_times
attendances (1) ──< (N) stamp_correction_requests
users (1) ──< (N) stamp_correction_requests (申請者、attendance経由)
stamp_correction_requests (1) ──< (N) break_corrections
```

---

## 設計のポイント

1. **正規化**: 休憩情報を別テーブルに分離し、複数回の休憩に対応
2. **拡張性**: メール認証機能（FN011, FN012）は既存の`email_verified_at`で対応可能
3. **CSV 出力**: `attendances`と`break_times`を JOIN して出力可能（FN045）
4. **効率性**: 必要最小限の 5 テーブルで全機能を実現
5. **整合性**: 外部キー制約でデータの整合性を保証

---

## 追加検討事項

### UNIQUE 制約の追加検討

-   `attendances`テーブル: `user_id`と`date`の組み合わせでユニーク制約を実装済み
    -   1 ユーザー 1 日 1 レコードを保証

### インデックス検討

-   `attendances.user_id`にインデックス
-   `attendances.date`にインデックス
-   `stamp_correction_requests.status`にインデックス
-   `stamp_correction_requests.attendance_id`にインデックス
