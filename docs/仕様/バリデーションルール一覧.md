# バリデーションルール一覧

## 概要

本アプリケーションで実装されているバリデーションルールとエラーメッセージの一覧です。

**注意**: 勤怠詳細画面（PG05）の修正申請では、日をまたぐ勤怠（例：23:00〜02:00）にも対応しています。元の勤怠レコードを参照して日をまたぐ勤怠かどうかを判定し、適切にバリデーションを行います。

---

## 1. 会員登録画面（PG01）

**実装クラス**: `App\Http\Requests\RegisterRequest`

### バリデーションルール

| フィールド | ルール                                                   | 説明                                                                        |
| ---------- | -------------------------------------------------------- | --------------------------------------------------------------------------- |
| `name`     | `required`, `string`, `max:255`                          | 必須入力、文字列型、最大 255 文字                                           |
| `email`    | `required`, `string`, `email`, `max:255`, `unique:users` | 必須入力、文字列型、メールアドレス形式、最大 255 文字、users テーブルで一意 |
| `password` | `required`, `string`, `min:8`, `confirmed`               | 必須入力、文字列型、最小 8 文字、確認用パスワードと一致                     |

### エラーメッセージ

| フィールド | ルール      | メッセージ                                |
| ---------- | ----------- | ----------------------------------------- |
| `name`     | `required`  | お名前を入力してください                  |
| `email`    | `required`  | メールアドレスを入力してください          |
| `email`    | `email`     | メールアドレスの形式が正しくありません    |
| `email`    | `unique`    | このメールアドレスは既に登録されています  |
| `password` | `required`  | パスワードを入力してください              |
| `password` | `min`       | パスワードは 8 文字以上で入力してください |
| `password` | `confirmed` | パスワードと一致しません                  |

---

## 2. ログイン画面（PG02）

**実装クラス**: `App\Http\Requests\LoginRequest`（FormRequest + `ValidatesLoginData`トレイト）

### バリデーションルール

| フィールド | ルール              | 説明                         |
| ---------- | ------------------- | ---------------------------- |
| `email`    | `required`, `email` | 必須入力、メールアドレス形式 |
| `password` | `required`          | 必須入力                     |

### エラーメッセージ

| フィールド | ルール             | メッセージ                             |
| ---------- | ------------------ | -------------------------------------- |
| `email`    | `required`         | メールアドレスを入力してください       |
| `email`    | `email`            | メールアドレスの形式が正しくありません |
| `password` | `required`         | パスワードを入力してください           |
| `email`    | （ログイン失敗時） | ログイン情報が登録されていません       |

**補足**:

-   ログイン失敗時（メールアドレスが存在しない、パスワードが間違っている、role が一般ユーザーでない場合）は、`ValidationException`で「ログイン情報が登録されていません」というメッセージを表示
-   `LoginRequest`は`ValidatesLoginData`トレイトを使用してバリデーションルールとメッセージを定義

---

## 3. 管理者ログイン画面（PG07）

**実装クラス**: `App\Http\Requests\AdminLoginRequest`（FormRequest + `ValidatesLoginData`トレイト）

### バリデーションルール

| フィールド | ルール              | 説明                         |
| ---------- | ------------------- | ---------------------------- |
| `email`    | `required`, `email` | 必須入力、メールアドレス形式 |
| `password` | `required`          | 必須入力                     |

### エラーメッセージ

| フィールド | ルール             | メッセージ                             |
| ---------- | ------------------ | -------------------------------------- |
| `email`    | `required`         | メールアドレスを入力してください       |
| `email`    | `email`            | メールアドレスの形式が正しくありません |
| `password` | `required`         | パスワードを入力してください           |
| `email`    | （ログイン失敗時） | ログイン情報が登録されていません       |

**補足**:

-   ログイン失敗時（メールアドレスが存在しない、パスワードが間違っている、role が管理者でない場合）は、`ValidationException`で「ログイン情報が登録されていません」というメッセージを表示
-   `AdminLoginRequest`は`ValidatesLoginData`トレイトを使用してバリデーションルールとメッセージを定義（一般ユーザーと共通）

---

## 4. 勤怠詳細画面（PG05）- 修正申請

**実装クラス**: `App\Http\Requests\AttendanceCorrectionRequest`（FormRequest + `ValidatesAttendanceData`トレイト）

### バリデーションルール

| フィールド            | ルール                          | 説明                                                                                                                 |
| --------------------- | ------------------------------- | -------------------------------------------------------------------------------------------------------------------- |
| `clock_in_time`       | `nullable`, `date_format:H:i`   | 空欄可、H:i 形式（例: 09:00）。日をまたぐ勤怠の場合も対応（例: 23:00）                                               |
| `clock_out_time`      | `nullable`, `date_format:H:i`   | 空欄可、H:i 形式（例: 18:00）。日をまたぐ勤怠の場合、翌日の時刻として扱われる（例: 02:00 は翌日の 02:00 として扱う） |
| `break_start_times`   | `nullable`, `array`             | 空欄可、配列型                                                                                                       |
| `break_start_times.*` | `nullable`, `date_format:H:i`   | 配列の各要素：空欄可、H:i 形式                                                                                       |
| `break_end_times`     | `nullable`, `array`             | 空欄可、配列型                                                                                                       |
| `break_end_times.*`   | `nullable`, `date_format:H:i`   | 配列の各要素：空欄可、H:i 形式                                                                                       |
| `note`                | `required`, `string`, `max:500` | 必須入力、文字列型、最大 500 文字                                                                                    |

### カスタムバリデーション（`withValidator()`メソッド）

以下の条件を満たさない場合、エラーメッセージを表示します：

1. **出勤時間と退勤時間の整合性**

    - **通常の勤怠の場合**: 出勤時間 < 退勤時間 でなければエラー
    - **日をまたぐ勤怠の場合**: 元の勤怠レコードが日をまたいでいる場合、以下のすべてのケースを正常として扱う（すべて翌日として扱う）：
        - 退勤時間が出勤時間より小さい場合（例：23:00 → 02:00）
        - 退勤時間が出勤時間より大きい場合（例：23:00 → 23:30）
        - 退勤時間 = 出勤時間の場合（24 時間勤務、例：23:00 → 23:00）
    - 判定方法: 元の勤怠レコードの`clock_in_time`と`clock_out_time`を参照し、退勤時間の日付が出勤時間の日付より後、または退勤時間が出勤時間より小さい場合は日をまたぐ勤怠と判定
    - エラー時: `clock_in_time`と`clock_out_time`に「出勤時間もしくは退勤時間が不適切な値です」

2. **休憩開始時間と休憩終了時間の整合性**

    - 条件: 休憩開始時間 < 休憩終了時間
    - エラー時: `break_start_times.*`と`break_end_times.*`に「休憩時間が不適切な値です」

3. **休憩開始時間と出勤時間の整合性**

    - 条件: 休憩開始時間 >= 出勤時間
    - エラー時: `break_start_times.*`に「休憩時間が不適切な値です」

4. **休憩開始時間と退勤時間の整合性**

    - **通常の勤怠の場合**: 休憩開始時間 <= 退勤時間 でなければエラー
    - **日をまたぐ勤怠の場合**: 退勤時間が出勤時間より小さい場合は翌日として扱うため、休憩開始時間が退勤時間より大きい場合はエラー（休憩時間は出勤日の範囲内である必要があるため）
    - エラー時: `break_start_times.*`に「休憩時間が不適切な値です」

5. **休憩終了時間と退勤時間の整合性**
    - **通常の勤怠の場合**: 休憩終了時間 <= 退勤時間 でなければエラー
    - **日をまたぐ勤怠の場合**: 退勤時間が出勤時間より小さい場合は翌日として扱うため、休憩終了時間が退勤時間より大きい場合はエラー（休憩時間は出勤日の範囲内である必要があるため）
    - エラー時: `break_end_times.*`に「休憩時間もしくは退勤時間が不適切な値です」

### エラーメッセージ

| フィールド            | ルール       | メッセージ                                                           |
| --------------------- | ------------ | -------------------------------------------------------------------- |
| `note`                | `required`   | 備考を記入してください                                               |
| `note`                | `max`        | 備考は 500 文字以内で入力してください                                |
| `clock_in_time`       | （カスタム） | 出勤時間もしくは退勤時間が不適切な値です                             |
| `clock_out_time`      | （カスタム） | 出勤時間もしくは退勤時間が不適切な値です                             |
| `break_start_times.*` | （カスタム） | 休憩時間が不適切な値です                                             |
| `break_end_times.*`   | （カスタム） | 休憩時間が不適切な値です<br>休憩時間もしくは退勤時間が不適切な値です |

---

## 5. 管理者勤怠詳細画面（PG09）- 修正フォーム

**実装クラス**: `App\Http\Requests\AdminAttendanceUpdateRequest`（FormRequest + `ValidatesAttendanceData`トレイト）

### バリデーションルール

管理者勤怠詳細画面のバリデーションルールは、勤怠詳細画面（PG05）の修正申請フォームと同じです。

| フィールド            | ルール                          | 説明                                                                                                                 |
| --------------------- | ------------------------------- | -------------------------------------------------------------------------------------------------------------------- |
| `clock_in_time`       | `nullable`, `date_format:H:i`   | 空欄可、H:i 形式（例: 09:00）。日をまたぐ勤怠の場合も対応（例: 23:00）                                               |
| `clock_out_time`      | `nullable`, `date_format:H:i`   | 空欄可、H:i 形式（例: 18:00）。日をまたぐ勤怠の場合、翌日の時刻として扱われる（例: 02:00 は翌日の 02:00 として扱う） |
| `break_start_times`   | `nullable`, `array`             | 空欄可、配列型                                                                                                       |
| `break_start_times.*` | `nullable`, `date_format:H:i`   | 配列の各要素：空欄可、H:i 形式                                                                                       |
| `break_end_times`     | `nullable`, `array`             | 空欄可、配列型                                                                                                       |
| `break_end_times.*`   | `nullable`, `date_format:H:i`   | 配列の各要素：空欄可、H:i 形式                                                                                       |
| `note`                | `required`, `string`, `max:500` | 必須入力、文字列型、最大 500 文字                                                                                    |

### カスタムバリデーション（`withValidator()`メソッド）

カスタムバリデーションの内容は、勤怠詳細画面（PG05）の修正申請フォームと同じです。詳細は「4. 勤怠詳細画面（PG05）- 修正申請」のセクションを参照してください。

**補足**:

-   `AdminAttendanceUpdateRequest`は`ValidatesAttendanceData`トレイトを使用してバリデーションルールとメッセージを定義（一般ユーザーと共通）
-   管理者のみがこのリクエストを送信可能（`authorize()`メソッドで管理者権限をチェック）

### エラーメッセージ

エラーメッセージは、勤怠詳細画面（PG05）の修正申請フォームと同じです。詳細は「4. 勤怠詳細画面（PG05）- 修正申請」のセクションを参照してください。

---

## バリデーションルールの読み方

### 基本的な表記

```php
'name' => ['required', 'string', 'max:255']
```

-   左から右に順に適用される
-   すべてのルールを満たす必要がある（AND 条件）
-   `:`の後はパラメータ（例: `max:255`は最大 255 文字）

### よく使うルール一覧

| ルール            | 意味                   | 例                                           |
| ----------------- | ---------------------- | -------------------------------------------- |
| `required`        | 必須入力               | `'name' => 'required'`                       |
| `nullable`        | 空欄可                 | `'note' => 'nullable'`                       |
| `string`          | 文字列型               | `'name' => 'string'`                         |
| `email`           | メールアドレス形式     | `'email' => 'email'`                         |
| `max:255`         | 最大 255 文字          | `'name' => 'max:255'`                        |
| `min:8`           | 最小 8 文字            | `'password' => 'min:8'`                      |
| `confirmed`       | 確認用フィールドと一致 | `'password' => 'confirmed'`                  |
| `unique:users`    | users テーブルで一意   | `'email' => 'unique:users'`                  |
| `date_format:H:i` | H:i 形式（時刻）       | `'clock_in_time' => 'date_format:H:i'`       |
| `array`           | 配列型                 | `'break_start_times' => 'array'`             |
| `.*`              | 配列の各要素           | `'break_start_times.*' => 'date_format:H:i'` |

### 読み方の例

**例 1**: `'name' => ['required', 'string', 'max:255']`

-   必須入力、文字列型、最大 255 文字

**例 2**: `'email' => ['required', 'string', 'email', 'max:255', 'unique:users']`

-   必須入力、文字列型、メールアドレス形式、最大 255 文字、users テーブルで一意

**例 3**: `'break_start_times.*' => ['nullable', 'date_format:H:i']`

-   配列の各要素：空欄可、H:i 形式

---

## 実装ファイル一覧

| 画面                       | 実装ファイル                                         | メソッド/クラス                                                                     |
| -------------------------- | ---------------------------------------------------- | ----------------------------------------------------------------------------------- |
| 会員登録画面（PG01）       | `app/Http/Requests/RegisterRequest.php`              | `rules()`, `messages()`                                                             |
| ログイン画面（PG02）       | `app/Http/Requests/LoginRequest.php`                 | `rules()`, `messages()`（`ValidatesLoginData`トレイト使用）                         |
| 管理者ログイン画面（PG07） | `app/Http/Requests/AdminLoginRequest.php`            | `rules()`, `messages()`（`ValidatesLoginData`トレイト使用）                         |
| 勤怠詳細画面（PG05）       | `app/Http/Requests/AttendanceCorrectionRequest.php`  | `rules()`, `withValidator()`, `messages()`（`ValidatesAttendanceData`トレイト使用） |
| 管理者勤怠詳細画面（PG09） | `app/Http/Requests/AdminAttendanceUpdateRequest.php` | `rules()`, `withValidator()`, `messages()`（`ValidatesAttendanceData`トレイト使用） |
| 勤怠詳細画面（PG05）       | `app/Http/Controllers/AttendanceController.php`      | `correctionRequest()` - 日をまたぐ勤怠の場合、退勤時間を翌日として保存              |

---

## 仕様との対応

### 機能要件一覧との対応

-   **FN003**: 会員登録画面のエラーメッセージ表示
-   **FN009**: ログイン画面のエラーメッセージ表示
-   **FN028**: 勤怠詳細画面のバリデーション機能
-   **FN029**: 勤怠詳細画面のエラーメッセージ表示機能

### 仕様で指定されているメッセージ

仕様（機能要件一覧.md）で指定されているメッセージは、すべて実装されています。

**会員登録画面（FN003）**:

-   ✅ お名前を入力してください
-   ✅ メールアドレスを入力してください
-   ✅ パスワードを入力してください
-   ✅ パスワードは 8 文字以上で入力してください
-   ✅ パスワードと一致しません

**ログイン画面（FN009）**:

-   ✅ メールアドレスを入力してください
-   ✅ パスワードを入力してください
-   ✅ ログイン情報が登録されていません

**勤怠詳細画面（FN029）**:

-   ✅ 出勤時間もしくは退勤時間が不適切な値です
-   ✅ 休憩時間が不適切な値です
-   ✅ 休憩時間もしくは退勤時間が不適切な値です
-   ✅ 備考を記入してください
